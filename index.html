<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cafe POS System - Responsive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
        }
        
        /* Mobile-first responsive design */
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .mobile-menu.open {
            transform: translateX(0);
        }
        
        /* Custom scrollbar for mobile */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        
        /* Receipt paper styling */
        .receipt-paper { 
            width: 80mm; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            line-height: 1.2; 
        }
        
        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .receipt-paper { 
                width: 100%; 
                max-width: 300px;
            }
            
            /* Touch-friendly buttons */
            .touch-btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Larger text for mobile */
            .mobile-text {
                font-size: 16px;
            }
            
            /* Better spacing on mobile */
            .mobile-spacing {
                padding: 1rem;
            }
        }
        
        /* Laptop optimizations */
        @media (min-width: 1024px) {
            .laptop-grid {
                display: grid;
                grid-template-columns: 1fr 400px;
                gap: 2rem;
            }
        }
        
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Card hover effects */
        .hover-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        /* Print styles */
        @media print {
            .no-print { display: none !important; }
            .receipt-paper { width: 100%; }
            body { font-size: 12px; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700 p-4">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-6 md:mb-8">
                <div class="text-4xl md:text-5xl mb-3">‚òï</div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Cafe POS System</h1>
                <p class="text-gray-600 text-sm md:text-base">Professional Point of Sale</p>
            </div>
            
            <form id="loginForm" class="space-y-4 md:space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-text" placeholder="Enter username" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-text" placeholder="Enter password" required>
                        <button type="button" onclick="togglePasswordVisibility()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 transition-colors touch-btn">
                            <svg id="eyeIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="eyeOffIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-200 font-medium touch-btn">
                    <span id="loginBtnText">Sign In</span>
                    <div id="loginLoader" class="loading hidden"></div>
                </button>
            </form>
            
            <!-- Demo Credentials -->
            <div class="mt-4 md:mt-6 p-4 bg-blue-50 rounded-lg">
                <h5 class="font-semibold text-blue-800 mb-2 text-sm md:text-base">Demo Credentials:</h5>
                <div class="text-xs md:text-sm space-y-1">
                    <div><strong>Admin:</strong> admin / admin123</div>
                    <div><strong>Staff:</strong> staff / staff123</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main POS Interface -->
    <div id="posInterface" class="hidden min-h-screen">
        <!-- Mobile Header -->
        <header class="bg-white shadow-sm border-b border-gray-200 px-4 py-3 md:px-6 md:py-4">
            <div class="flex justify-between items-center">
                <!-- Mobile Menu Button -->
                <button onclick="toggleMobileMenu()" class="md:hidden bg-gray-100 p-2 rounded-lg touch-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
                
                <!-- Logo and Title -->
                <div class="flex items-center space-x-2 md:space-x-4">
                    <h1 class="text-lg md:text-2xl font-bold text-gray-800">‚òï Cafe POS</h1>
                    <span class="bg-blue-100 text-blue-800 px-2 md:px-3 py-1 rounded-full text-xs md:text-sm font-medium" id="userRole">Staff</span>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-4">
                    <div class="text-center">
                        <span class="text-gray-600 block text-sm" id="currentUser">Welcome, User</span>
                        <div class="text-sm font-semibold text-blue-600" id="realTimeDate"></div>
                        <div class="text-xs text-gray-500" id="realTimeTime"></div>
                        <div class="text-xs mt-1">
                            <span id="shiftStatus" class="bg-red-100 text-red-800 px-2 py-1 rounded-full">Shift Closed</span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                        <div class="text-xs text-blue-600 font-medium">Exchange Rate</div>
                        <div class="text-sm font-bold text-blue-800 flex items-center gap-2">
                            <span>1 USD = ·üõ</span>
                            <span id="navExchangeRate" class="cursor-pointer hover:bg-blue-100 px-1 rounded" onclick="quickEditExchangeRate()" title="Click to edit">4,100</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="showReports()" class="bg-purple-600 text-white px-3 py-2 rounded-lg hover:bg-purple-700 transition text-sm touch-btn">üìä</button>
                        <button onclick="toggleShift()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm touch-btn" id="shiftBtn">üïê</button>
                        <button onclick="showSettings()" class="bg-gray-600 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition text-sm touch-btn" id="settingsBtn">‚öôÔ∏è</button>
                        <button onclick="logout()" class="bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition text-sm touch-btn">Logout</button>
                    </div>
                </div>
                
                <!-- Mobile Cart Button -->
                <button onclick="toggleMobileCart()" class="md:hidden bg-blue-600 text-white p-2 rounded-lg relative touch-btn">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5m6-5v6a2 2 0 11-4 0v-6m4 0V9a2 2 0 10-4 0v4.01"></path>
                    </svg>
                    <span id="cartItemCount" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
                </button>
            </div>
        </header>

        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" class="mobile-menu fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg md:hidden">
            <div class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="font-semibold text-gray-800">Menu</h2>
                    <button onclick="toggleMobileMenu()" class="text-gray-500 touch-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="mt-2 text-sm text-gray-600" id="mobileCurrentUser">Welcome, User</div>
                <div class="text-xs mt-1">
                    <span id="mobileShiftStatus" class="bg-red-100 text-red-800 px-2 py-1 rounded-full">Shift Closed</span>
                </div>
            </div>
            
            <nav class="p-4 space-y-2">
                <button onclick="showReports(); toggleMobileMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition touch-btn">üìä Reports</button>
                <button onclick="toggleShift(); toggleMobileMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition touch-btn" id="mobileShiftBtn">üïê Start Shift</button>
                <button onclick="showSettings(); toggleMobileMenu();" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition touch-btn" id="mobileSettingsBtn">‚öôÔ∏è Settings</button>
                <button onclick="quickEditExchangeRate()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition touch-btn">üí± Exchange Rate</button>
                <hr class="my-4">
                <button onclick="logout()" class="w-full text-left px-4 py-3 rounded-lg hover:bg-red-100 text-red-600 transition touch-btn">üö™ Logout</button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col md:flex-row min-h-screen">
            <!-- Menu Section -->
            <div class="flex-1 p-4 md:p-6 custom-scroll overflow-y-auto">
                <!-- Categories -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg md:text-xl font-semibold text-gray-800">Categories</h2>
                        <button onclick="showAddCategory()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition text-sm touch-btn" id="addCategoryBtn" style="display:none;">+ Add</button>
                    </div>
                    <div id="categoriesContainer" class="flex flex-wrap gap-2 mb-6">
                        <!-- Categories will be populated here -->
                    </div>
                </div>

                <!-- Menu Items -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg md:text-xl font-semibold text-gray-800">Menu Items</h2>
                        <button onclick="showAddItem()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition text-sm touch-btn" id="addItemBtn" style="display:none;">+ Add</button>
                    </div>
                    <div id="menuItemsContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                        <!-- Menu items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Order Summary & Checkout - Desktop -->
            <div class="hidden md:block w-full md:w-96 bg-white border-l border-gray-200 p-6 custom-scroll overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800">Current Order</h2>
                    <div class="text-right">
                        <span class="bg-gray-100 px-3 py-1 rounded-lg text-sm font-medium" id="receiptNumber">Receipt #001</span>
                        <div class="text-xs text-gray-500 mt-1" id="receiptProgress" style="display:none;">0/100 receipts</div>
                    </div>
                </div>

                <!-- Order Items -->
                <div id="orderItems" class="space-y-3 mb-6 max-h-64 overflow-y-auto custom-scroll">
                    <p class="text-gray-500 text-center py-4">No items in order</p>
                </div>

                <!-- Discount Section -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-3">Discount</h3>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <button onclick="applyDiscount(10)" class="bg-blue-500 text-white px-2 py-2 rounded hover:bg-blue-600 transition text-sm touch-btn">10%</button>
                        <button onclick="applyDiscount(20)" class="bg-blue-500 text-white px-2 py-2 rounded hover:bg-blue-600 transition text-sm touch-btn">20%</button>
                        <button onclick="applyDiscount(50)" class="bg-orange-500 text-white px-2 py-2 rounded hover:bg-orange-600 transition text-sm touch-btn">50%</button>
                        <button onclick="applyDiscount(100)" class="bg-red-500 text-white px-2 py-2 rounded hover:bg-red-600 transition text-sm touch-btn">100%</button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="showCustomDiscount()" class="bg-purple-500 text-white px-3 py-2 rounded hover:bg-purple-600 transition text-sm touch-btn">Custom</button>
                        <button onclick="removeDiscount()" class="bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600 transition text-sm touch-btn">Remove</button>
                    </div>
                </div>

                <!-- Order Total -->
                <div class="border-t border-gray-200 pt-4 mb-6">
                    <div class="flex justify-between text-lg font-semibold">
                        <span>Total:</span>
                        <span id="orderTotal">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm text-blue-600 mt-1">
                        <span>KHR Total:</span>
                        <span id="orderTotalKHR">·üõ0</span>
                    </div>
                    <div id="discountInfo" class="text-sm text-green-600 mt-1" style="display:none;"></div>
                </div>

                <!-- Payment Buttons -->
                <div class="space-y-3">
                    <button onclick="processPayment('Cash')" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium touch-btn">üíµ Pay with Cash</button>
                    <button onclick="processPayment('QRCode')" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium touch-btn">üì± Pay with QR Code</button>
                    <button onclick="showVoidReceipt()" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 transition font-medium touch-btn">üóëÔ∏è Void Receipt</button>
                </div>
            </div>
        </div>

        <!-- Mobile Cart Overlay -->
        <div id="mobileCart" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[80vh] overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Current Order</h2>
                    <button onclick="toggleMobileCart()" class="text-gray-500 touch-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="p-4 custom-scroll overflow-y-auto" style="max-height: calc(80vh - 200px);">
                    <!-- Mobile Order Items -->
                    <div id="mobileOrderItems" class="space-y-3 mb-4">
                        <p class="text-gray-500 text-center py-4">No items in order</p>
                    </div>
                    
                    <!-- Mobile Discount -->
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2 text-sm">Quick Discount</h3>
                        <div class="grid grid-cols-4 gap-2 mb-2">
                            <button onclick="applyDiscount(10)" class="bg-blue-500 text-white py-2 rounded text-sm touch-btn">10%</button>
                            <button onclick="applyDiscount(20)" class="bg-blue-500 text-white py-2 rounded text-sm touch-btn">20%</button>
                            <button onclick="applyDiscount(50)" class="bg-orange-500 text-white py-2 rounded text-sm touch-btn">50%</button>
                            <button onclick="removeDiscount()" class="bg-gray-500 text-white py-2 rounded text-sm touch-btn">Clear</button>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Payment Section -->
                <div class="p-4 border-t bg-gray-50">
                    <div class="flex justify-between text-lg font-semibold mb-3">
                        <span>Total:</span>
                        <div class="text-right">
                            <div id="mobileOrderTotal">$0.00</div>
                            <div class="text-sm text-blue-600" id="mobileOrderTotalKHR">·üõ0</div>
                        </div>
                    </div>
                    <div id="mobileDiscountInfo" class="text-sm text-green-600 mb-3" style="display:none;"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="processPayment('Cash')" class="bg-green-600 text-white py-3 rounded-lg font-medium touch-btn">üíµ Cash</button>
                        <button onclick="processPayment('QRCode')" class="bg-blue-600 text-white py-3 rounded-lg font-medium touch-btn">üì± QR Code</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Modals (same as before but with responsive classes) -->
    <!-- Reports Modal -->
    <div id="reportsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-6xl max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h3 class="text-xl md:text-2xl font-semibold">üìä Sales Reports</h3>
                <button onclick="closeModal('reportsModal')" class="text-gray-500 hover:text-gray-700 text-2xl font-bold touch-btn">√ó</button>
            </div>
            
            <!-- Report Filters -->
            <div class="mb-4 md:mb-6 p-3 md:p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 md:gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                        <input type="date" id="reportFromDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                        <input type="date" id="reportToDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Type</label>
                        <select id="reportPaymentType" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                            <option value="">All Payment Types</option>
                            <option value="Cash">Cash</option>
                            <option value="QRCode">QR Code</option>
                        </select>
                    </div>
                    
                </div>
                
                <!-- Quick Action Buttons -->
                <div class="flex flex-wrap gap-2 mt-3">
                    <button onclick="setQuickDateRange('today')" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition text-sm touch-btn">Today</button>
                    <button onclick="setQuickDateRange('yesterday')" class="px-3 py-1 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 transition text-sm touch-btn">Yesterday</button>
                    <button onclick="setQuickDateRange('this_week')" class="px-3 py-1 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 transition text-sm touch-btn">This Week</button>
                    <button onclick="setQuickDateRange('last_7_days')" class="px-3 py-1 bg-orange-100 text-orange-800 rounded-lg hover:bg-orange-200 transition text-sm touch-btn">Last 7 Days</button>
                    <button onclick="setQuickDateRange('this_month')" class="px-3 py-1 bg-pink-100 text-pink-800 rounded-lg hover:bg-pink-200 transition text-sm touch-btn">This Month</button>
                    <button onclick="setQuickDateRange('last_30_days')" class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-lg hover:bg-indigo-200 transition text-sm touch-btn">Last 30 Days</button>
                </div>
            </div>
            
            <!-- Report Tabs -->
            <div class="mb-4 md:mb-6">
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg overflow-x-auto">
                    <button onclick="showReportTab('sales')" id="salesReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md bg-white text-blue-600 font-medium text-sm">Sales</button>
                    <button onclick="showReportTab('items')" id="itemsReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Items</button>
                    <button onclick="showReportTab('slow')" id="slowReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Slow Items</button>
                    <button onclick="showReportTab('void')" id="voidReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Voids</button>
                    <button onclick="showReportTab('shifts')" id="shiftsReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Shifts</button>
                    <button onclick="showReportTab('financial')" id="financialReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Financial</button>
                    <button onclick="showReportTab('activity')" id="activityReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Activity Log</button>
                    <button onclick="showReportTab('backup')" id="backupReportTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Backup</button>
                </div>
            </div>
            
            <!-- Report Content Areas -->
            <div id="salesReport" class="report-tab">
                <div id="salesReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view sales summary</p>
                </div>
            </div>
            
            <div id="itemsReport" class="report-tab hidden">
                <div id="itemsReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view item performance</p>
                </div>
            </div>
            
            <div id="slowReport" class="report-tab hidden">
                <div id="slowReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view slow moving items</p>
                </div>
            </div>
            
            <div id="voidReport" class="report-tab hidden">
                <div id="voidReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view void details</p>
                </div>
            </div>
            
            <div id="shiftsReport" class="report-tab hidden">
                <div id="shiftsReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view shift details</p>
                </div>
            </div>
            
            <div id="financialReport" class="report-tab hidden">
                <div id="financialReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view financial ledger</p>
                </div>
            </div>
            
            <div id="activityReport" class="report-tab hidden">
                <div id="activityReportContent" class="space-y-4">
                    <p class="text-gray-500 text-center py-8">Click "Generate Report" to view activity log</p>
                </div>
            </div>
            
            <div id="backupReport" class="report-tab hidden">
                <div id="backupReportContent" class="space-y-4">
                    <!-- Backup & Restore System -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Backup Section -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-green-800 mb-4 flex items-center gap-2">
                                üíæ System Backup
                            </h4>
                            
                            <div class="space-y-4">
                                <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                                    <h5 class="font-medium text-green-800 mb-2">Full System Backup</h5>
                                    <p class="text-sm text-green-700 mb-3">Backup all data including transactions, users, settings, and menu items.</p>
                                    <button onclick="createFullBackup()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition touch-btn">
                                        üì¶ Create Full Backup
                                    </button>
                                </div>
                                
                                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <h5 class="font-medium text-blue-800 mb-2">Transactions Only</h5>
                                    <p class="text-sm text-blue-700 mb-3">Backup only transaction data and financial records.</p>
                                    <button onclick="createTransactionBackup()" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition touch-btn">
                                        üßæ Backup Transactions
                                    </button>
                                </div>
                                
                                <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                                    <h5 class="font-medium text-purple-800 mb-2">Settings & Users</h5>
                                    <p class="text-sm text-purple-700 mb-3">Backup system settings and user accounts.</p>
                                    <button onclick="createSettingsBackup()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition touch-btn">
                                        ‚öôÔ∏è Backup Settings
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Restore Section -->
                        <div class="bg-white p-4 rounded-lg border">
                            <h4 class="font-semibold text-orange-800 mb-4 flex items-center gap-2">
                                üì• System Restore
                            </h4>
                            
                            <div class="space-y-4">
                                <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                                    <h5 class="font-medium text-orange-800 mb-2">Restore from File</h5>
                                    <p class="text-sm text-orange-700 mb-3">Upload and restore from a backup file.</p>
                                    <input type="file" id="restoreFileInput" accept=".json" class="w-full mb-2 text-sm border border-orange-300 rounded-lg p-2">
                                    <button onclick="restoreFromFile()" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition touch-btn">
                                        üì§ Restore Data
                                    </button>
                                </div>
                                
                                <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <h5 class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Important Notes</h5>
                                    <div class="text-sm text-yellow-700 space-y-1">
                                        <div>‚Ä¢ Restoring will overwrite current data</div>
                                        <div>‚Ä¢ Create a backup before restoring</div>
                                        <div>‚Ä¢ Only restore trusted backup files</div>
                                        <div>‚Ä¢ System will reload after restore</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Backup History -->
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            üìã Backup History
                        </h4>
                        <div id="backupHistoryList" class="space-y-2">
                            <p class="text-gray-500 text-center py-4">No backup history available</p>
                        </div>
                    </div>
                    
                    <!-- Auto Backup Settings -->
                    <div class="bg-white p-4 rounded-lg border">
                        <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            üîÑ Auto Backup Settings
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Auto Backup Frequency</label>
                                <select id="autoBackupFrequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" onchange="updateAutoBackupSettings()">
                                    <option value="disabled">Disabled</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Backup Type</label>
                                <select id="autoBackupType" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                                    <option value="full">Full System</option>
                                    <option value="transactions">Transactions Only</option>
                                    <option value="settings">Settings Only</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Keep Backups</label>
                                <select id="autoBackupRetention" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                                    <option value="5">Last 5 backups</option>
                                    <option value="10">Last 10 backups</option>
                                    <option value="30">Last 30 backups</option>
                                    <option value="unlimited">Unlimited</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="font-medium text-blue-800">Next Auto Backup:</div>
                                    <div class="text-sm text-blue-600" id="nextAutoBackup">Not scheduled</div>
                                </div>
                                <button onclick="triggerManualAutoBackup()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition touch-btn">
                                    üîÑ Backup Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Options -->
            <div class="mt-4 md:mt-6 flex flex-col md:flex-row justify-end gap-3">
                <button onclick="exportReportToExcel()" class="bg-green-600 text-white px-4 md:px-6 py-2 rounded-lg hover:bg-green-700 transition touch-btn">üìä Export Excel</button>
                <button onclick="printReport()" class="bg-blue-600 text-white px-4 md:px-6 py-2 rounded-lg hover:bg-blue-700 transition touch-btn">üñ®Ô∏è Print</button>
                <button onclick="closeModal('reportsModal')" class="bg-gray-500 text-white px-4 md:px-6 py-2 rounded-lg hover:bg-gray-600 transition touch-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Other modals with responsive classes... -->
    <!-- Sugar Options Modal -->
    <div id="sugarModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-sm">
            <h3 class="text-lg md:text-xl font-semibold mb-4">Sugar Options</h3>
            <div class="space-y-3">
                <button onclick="selectSugarOption('No Sugar')" class="w-full bg-blue-100 text-blue-800 py-3 rounded-lg hover:bg-blue-200 transition touch-btn">üö´ No Sugar</button>
                <button onclick="selectSugarOption('Normal')" class="w-full bg-green-100 text-green-800 py-3 rounded-lg hover:bg-green-200 transition touch-btn">‚úÖ Normal</button>
                <button onclick="selectSugarOption('Sweet')" class="w-full bg-yellow-100 text-yellow-800 py-3 rounded-lg hover:bg-yellow-200 transition touch-btn">üçØ Sweet</button>
            </div>
            <button onclick="closeModal('sugarModal')" class="w-full mt-4 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition touch-btn">Cancel</button>
        </div>
    </div>

    <!-- Quantity Selection Modal -->
    <div id="quantityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-sm">
            <h3 class="text-lg md:text-xl font-semibold mb-4">Select Quantity</h3>
            
            <!-- Item Info -->
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <p class="font-medium" id="quantityItemName">Item Name</p>
                <p class="text-sm text-gray-600" id="quantityItemPrice">$0.00 each</p>
                <p class="text-sm text-blue-600" id="quantityItemSugar">Sugar option</p>
            </div>
            
            <!-- Quantity Controls -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quantity</label>
                <div class="flex items-center justify-center space-x-4">
                    <button onclick="changeQuantity(-1)" class="bg-red-500 text-white w-12 h-12 rounded-full hover:bg-red-600 transition font-bold text-lg touch-btn">-</button>
                    <span class="text-2xl font-bold w-12 text-center" id="selectedQuantity">1</span>
                    <button onclick="changeQuantity(1)" class="bg-green-500 text-white w-12 h-12 rounded-full hover:bg-green-600 transition font-bold text-lg touch-btn">+</button>
                </div>
                
                <!-- Quick quantity buttons -->
                <div class="grid grid-cols-5 gap-2 mt-4">
                    <button onclick="setQuantity(1)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm touch-btn">1</button>
                    <button onclick="setQuantity(2)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm touch-btn">2</button>
                    <button onclick="setQuantity(3)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm touch-btn">3</button>
                    <button onclick="setQuantity(5)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm touch-btn">5</button>
                    <button onclick="setQuantity(10)" class="bg-gray-100 text-gray-800 py-2 rounded hover:bg-gray-200 transition text-sm touch-btn">10</button>
                </div>
            </div>
            
            <!-- Total Price Display -->
            <div class="mb-4 p-3 bg-green-50 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="text-green-700">Total Price:</span>
                    <span class="text-xl font-bold text-green-800" id="totalItemPrice">$0.00</span>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="space-y-3">
                <button onclick="confirmAddToOrder()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium touch-btn">Add to Order</button>
                <button onclick="closeModal('quantityModal')" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition touch-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Receipt Print Modal -->
    <div id="receiptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg md:text-xl font-semibold">üßæ Receipt</h3>
                <button onclick="closeModal('receiptModal')" class="text-gray-500 hover:text-gray-700 text-xl font-bold touch-btn">√ó</button>
            </div>
            
            <!-- Receipt Preview -->
            <div id="receiptPreview" class="receipt-paper bg-white border p-4 mb-4 max-h-96 overflow-y-auto custom-scroll">
                <!-- Receipt content will be generated here -->
            </div>
            
            <!-- Print Options -->
            <div class="flex gap-3">
                <button onclick="printReceipt()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition touch-btn">üñ®Ô∏è Print</button>
                <button onclick="closeModal('receiptModal')" class="flex-1 bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition touch-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h3 class="text-xl md:text-2xl font-semibold">‚öôÔ∏è System Settings</h3>
                <button onclick="closeModal('settingsModal')" class="text-gray-500 hover:text-gray-700 text-2xl font-bold touch-btn">√ó</button>
            </div>
            
            <!-- Settings Tabs -->
            <div class="mb-4 md:mb-6">
                <div class="flex space-x-1 bg-gray-100 p-1 rounded-lg overflow-x-auto">
                    <button onclick="showSettingsTab('business')" id="businessSettingsTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md bg-white text-blue-600 font-medium text-sm">Business</button>
                    <button onclick="showSettingsTab('users')" id="usersSettingsTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">Users</button>
                    <button onclick="showSettingsTab('system')" id="systemSettingsTab" class="flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm">System</button>
                </div>
            </div>
            
            <!-- Business Settings Tab -->
            <div id="businessSettings" class="settings-tab">
                <form id="businessSettingsForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label>
                            <input type="text" id="settingsBusinessName" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Exchange Rate (USD to KHR)</label>
                            <input type="number" id="settingsExchangeRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" min="1" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Address</label>
                        <textarea id="settingsBusinessAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" rows="3"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">WiFi Name</label>
                            <input type="text" id="settingsWifiName" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">WiFi Password</label>
                            <input type="text" id="settingsWifiPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tax Rate (%)</label>
                        <input type="number" id="settingsTaxRate" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" min="0" max="100" step="0.01">
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-medium touch-btn">Save Business Settings</button>
                </form>
            </div>
            
            <!-- Users Settings Tab -->
            <div id="usersSettings" class="settings-tab hidden">
                <div class="mb-4">
                    <button onclick="showAddUser()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition touch-btn">+ Add New User</button>
                </div>
                
                <div id="usersList" class="space-y-3">
                    <!-- Users will be populated here -->
                </div>
            </div>
            
            <!-- System Settings Tab -->
            <div id="systemSettings" class="settings-tab hidden">
                <div class="space-y-4">
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800 mb-2">‚ö†Ô∏è System Actions</h4>
                        <p class="text-sm text-yellow-700 mb-4">These actions cannot be undone. Please use with caution.</p>
                        
                        <div class="space-y-3">
                            <button onclick="clearAllTransactions()" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition touch-btn">Clear All Transactions</button>
                            <button onclick="resetSystem()" class="w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition touch-btn">Reset System to Default</button>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-2">üìä System Information</h4>
                        <div class="text-sm text-blue-700 space-y-1">
                            <div>Total Transactions: <span class="font-medium" id="totalTransactionsCount">0</span></div>
                            <div>Total Revenue: <span class="font-medium" id="totalRevenueAmount">$0.00</span></div>
                            <div>Active Users: <span class="font-medium" id="activeUsersCount">0</span></div>
                            <div>Menu Items: <span class="font-medium" id="menuItemsCount">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Void Receipt Modal -->
    <div id="voidModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-4 md:mb-6">
                <h3 class="text-xl md:text-2xl font-semibold">üóëÔ∏è Void Receipt</h3>
                <button onclick="closeModal('voidModal')" class="text-gray-500 hover:text-gray-700 text-2xl font-bold touch-btn">√ó</button>
            </div>
            
            <div class="mb-4 p-3 bg-red-50 rounded-lg border border-red-200">
                <h4 class="font-semibold text-red-800 mb-2">‚ö†Ô∏è Important Notice</h4>
                <p class="text-sm text-red-700">Voiding a receipt will reverse the transaction and update financial records. This action cannot be undone.</p>
            </div>
            
            <!-- Recent Transactions for Voiding -->
            <div class="mb-6">
                <h4 class="font-semibold text-gray-800 mb-3">Recent Transactions (Last 7 days)</h4>
                <div id="voidableTransactionsList" class="space-y-2 max-h-64 overflow-y-auto custom-scroll">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
            
            <!-- Void Reason Form -->
            <div id="voidReasonForm" class="hidden">
                <h4 class="font-semibold text-gray-800 mb-3">Void Reason</h4>
                <div class="space-y-3 mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="voidReason" value="Customer Request" class="text-blue-600">
                        <span class="text-sm">Customer Request</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="voidReason" value="Wrong Order" class="text-blue-600">
                        <span class="text-sm">Wrong Order</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="voidReason" value="Payment Issue" class="text-blue-600">
                        <span class="text-sm">Payment Issue</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="voidReason" value="System Error" class="text-blue-600">
                        <span class="text-sm">System Error</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="voidReason" value="Other" class="text-blue-600">
                        <span class="text-sm">Other</span>
                    </label>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes (Optional)</label>
                    <textarea id="voidNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" rows="3" placeholder="Enter any additional details..."></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="confirmVoidTransaction()" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium touch-btn">Confirm Void</button>
                    <button onclick="cancelVoid()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition touch-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-4 md:p-6 rounded-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg md:text-xl font-semibold">üë§ Add New User</h3>
                <button onclick="closeModal('addUserModal')" class="text-gray-500 hover:text-gray-700 text-xl font-bold touch-btn">√ó</button>
            </div>
            
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="newUserFullName" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="newUserUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="newUserPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="newUserRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg mobile-text" required>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                
                <div class="flex gap-3">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-medium touch-btn">Add User</button>
                    <button type="button" onclick="closeModal('addUserModal')" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition touch-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentOrder = [];
        let receiptCounter = 1;
        let currentItem = null;
        let currentSugarOption = null;
        let selectedQuantity = 1;
        let discountPercent = 0;
        let realTimeInterval = null;
        let transactionHistory = [];
        let voidHistory = [];
        let currentReportData = null;
        let currentReportType = 'sales';
        let currentShift = null;
        let shiftHistory = [];
        let financialLedger = [];
        let isMobileCartOpen = false;
        let isMobileMenuOpen = false;
        let activityLog = []; // New activity logging system
        let backupHistory = []; // Backup history tracking
        let autoBackupSettings = {
            frequency: 'disabled',
            type: 'full',
            retention: 10,
            nextBackup: null,
            lastBackup: null
        };

        // System data
        let systemUsers = [
            { id: 1, username: 'admin', password: 'admin123', role: 'admin', fullName: 'System Administrator', active: true },
            { id: 2, username: 'staff', password: 'staff123', role: 'staff', fullName: 'Staff Member', active: true }
        ];

        let systemSettings = {
            businessName: 'Cafe POS System',
            businessAddress: '123 Main Street, City, Country',
            wifiName: 'Cafe_WiFi',
            wifiPassword: 'cafe123456',
            exchangeRate: 4100,
            taxRate: 0
        };

        // Sample menu data
        let categories = ['Coffee', 'Tea', 'Pastries', 'Beverages'];
        let menuItems = [
            { id: 1, name: 'Espresso', category: 'Coffee', price: 3.50, image: '' },
            { id: 2, name: 'Cappuccino', category: 'Coffee', price: 4.25, image: '' },
            { id: 3, name: 'Latte', category: 'Coffee', price: 4.75, image: '' },
            { id: 4, name: 'Green Tea', category: 'Tea', price: 2.50, image: '' },
            { id: 5, name: 'Earl Grey', category: 'Tea', price: 2.75, image: '' },
            { id: 6, name: 'Croissant', category: 'Pastries', price: 3.00, image: '' },
            { id: 7, name: 'Muffin', category: 'Pastries', price: 2.75, image: '' },
            { id: 8, name: 'Orange Juice', category: 'Beverages', price: 3.25, image: '' }
        ];

        // Mobile-specific functions
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            isMobileMenuOpen = !isMobileMenuOpen;
            
            if (isMobileMenuOpen) {
                menu.classList.add('open');
            } else {
                menu.classList.remove('open');
            }
        }

        function toggleMobileCart() {
            const cart = document.getElementById('mobileCart');
            isMobileCartOpen = !isMobileCartOpen;
            
            if (isMobileCartOpen) {
                cart.classList.remove('hidden');
                updateMobileOrderDisplay();
            } else {
                cart.classList.add('hidden');
            }
        }

        function updateCartItemCount() {
            const count = currentOrder.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartItemCount').textContent = count;
        }

        function updateMobileOrderDisplay() {
            const container = $('#mobileOrderItems');
            container.empty();
            
            if (currentOrder.length === 0) {
                container.html('<p class="text-gray-500 text-center py-4">No items in order</p>');
            } else {
                currentOrder.forEach(item => {
                    container.append(`
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium text-sm">${item.name}</h4>
                                <p class="text-xs text-gray-600">${item.sugarOption !== 'N/A' ? item.sugarOption : ''}</p>
                                <div class="flex items-center space-x-2 mt-2">
                                    <button onclick="changeOrderItemQuantity(${item.id}, -1)" class="bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600 transition text-xs font-bold touch-btn">-</button>
                                    <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                                    <button onclick="changeOrderItemQuantity(${item.id}, 1)" class="bg-green-500 text-white w-8 h-8 rounded-full hover:bg-green-600 transition text-xs font-bold touch-btn">+</button>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-sm">$${(item.price * item.quantity).toFixed(2)}</p>
                                <button onclick="removeFromOrder(${item.id})" class="text-red-500 hover:text-red-700 text-xs touch-btn">Remove</button>
                            </div>
                        </div>
                    `);
                });
            }
            
            updateMobileTotal();
        }

        function updateMobileTotal() {
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountAmount = subtotal * (discountPercent / 100);
            const total = Math.max(0, subtotal - discountAmount);
            const totalKHR = Math.round(total * systemSettings.exchangeRate);
            
            document.getElementById('mobileOrderTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('mobileOrderTotalKHR').textContent = `·üõ${totalKHR.toLocaleString()}`;
            
            const discountInfo = document.getElementById('mobileDiscountInfo');
            if (discountAmount > 0) {
                discountInfo.style.display = 'block';
                discountInfo.textContent = `Discount ${discountPercent}%: -$${discountAmount.toFixed(2)}`;
            } else {
                discountInfo.style.display = 'none';
            }
        }

        // Initialize system
        $(document).ready(function() {
            // Close mobile menu when clicking outside
            $(document).on('click', function(e) {
                if (isMobileMenuOpen && !$(e.target).closest('#mobileMenu, button[onclick="toggleMobileMenu()"]').length) {
                    toggleMobileMenu();
                }
            });
            
            // Close mobile cart when clicking outside
            $(document).on('click', function(e) {
                if (isMobileCartOpen && !$(e.target).closest('#mobileCart > div, button[onclick="toggleMobileCart()"]').length) {
                    toggleMobileCart();
                }
            });
        });

        // Authentication System
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            
            const username = $('#username').val().trim();
            const password = $('#password').val();
            
            if (!username || !password) {
                alert('Please enter both username and password');
                return;
            }
            
            // Find user in system
            const user = systemUsers.find(u => u.username === username && u.password === password && u.active);
            
            if (user) {
                currentUser = {
                    id: user.id,
                    username: user.username,
                    role: user.role,
                    fullName: user.fullName
                };
                
                // Log successful login
                logUserLogin(username, true);
                
                $('#loginScreen').addClass('hidden');
                $('#posInterface').removeClass('hidden');
                $('#currentUser').text(`Welcome, ${currentUser.fullName}`);
                $('#mobileCurrentUser').text(`Welcome, ${currentUser.fullName}`);
                $('#userRole').text(currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1));
                
                // Set role-based permissions
                setupRolePermissions(currentUser.role);
                
                initializeSystem();
                loadMenuData();
                startRealTimeClock();
                updateShiftStatus();
                
                // Log system initialization
                logActivity('system_initialized', {
                    user_role: currentUser.role,
                    menu_items_count: menuItems.length,
                    exchange_rate: systemSettings.exchangeRate
                });
                
                // Save to database (simulated)
                saveToDatabase('user_login', {
                    user: currentUser.username,
                    timestamp: new Date().toISOString()
                });
            } else {
                // Log failed login attempt
                const failureReason = systemUsers.find(u => u.username === username) ? 
                    (systemUsers.find(u => u.username === username && u.password === password) ? 'account_disabled' : 'wrong_password') : 
                    'user_not_found';
                
                logUserLogin(username, false, failureReason);
                logSecurityEvent('failed_login_attempt', {
                    attempted_username: username,
                    failure_reason: failureReason,
                    ip_address: 'localhost'
                });
                
                alert('Invalid username or password, or account is disabled');
                $('#password').val('');
            }
        });

        // Database simulation
        function saveToDatabase(table, data) {
            console.log(`Saving to ${table}:`, data);
        }

        // Activity Logging System
        function logActivity(action, details = {}, level = 'info') {
            const logEntry = {
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.username : 'system',
                user_role: currentUser ? currentUser.role : 'system',
                action: action,
                details: details,
                level: level, // info, warning, error, critical
                ip_address: 'localhost', // In real app, get actual IP
                user_agent: navigator.userAgent,
                shift_id: currentShift ? currentShift.shift_id : null,
                session_id: currentUser ? `${currentUser.username}_${Date.now()}` : null
            };
            
            activityLog.push(logEntry);
            
            // Keep only last 10000 entries to prevent memory issues
            if (activityLog.length > 10000) {
                activityLog = activityLog.slice(-10000);
            }
            
            // Save to database
            saveToDatabase('activity_log', logEntry);
            
            // Console log for debugging (can be removed in production)
            const levelEmoji = {
                'info': '‚ÑπÔ∏è',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'critical': 'üö®'
            };
            
            console.log(`${levelEmoji[level]} [${logEntry.timestamp}] ${logEntry.user} (${logEntry.user_role}): ${action}`, details);
        }

        // Enhanced logging for specific activities
        function logUserLogin(username, success, reason = '') {
            logActivity('user_login', {
                username: username,
                success: success,
                reason: reason,
                login_time: new Date().toISOString()
            }, success ? 'info' : 'warning');
        }

        function logUserLogout(username, reason = 'manual') {
            logActivity('user_logout', {
                username: username,
                reason: reason,
                logout_time: new Date().toISOString()
            }, 'info');
        }

        function logTransaction(transaction, action = 'created') {
            logActivity(`transaction_${action}`, {
                receipt_number: transaction.receipt_number,
                total: transaction.total,
                payment_type: transaction.payment_type,
                items_count: transaction.items.length,
                cashier: transaction.cashier
            }, 'info');
        }

        function logVoidTransaction(voidRecord) {
            logActivity('transaction_voided', {
                void_id: voidRecord.void_id,
                original_receipt: voidRecord.original_receipt,
                void_amount: voidRecord.void_amount,
                void_reason: voidRecord.void_reason,
                voided_by: voidRecord.voided_by
            }, 'warning');
        }

        function logShiftActivity(shiftAction, shiftData) {
            logActivity(`shift_${shiftAction}`, {
                shift_id: shiftData.shift_id,
                cashier: shiftData.cashier,
                starting_cash: shiftData.starting_cash,
                ending_cash: shiftData.ending_cash,
                total_sales: shiftData.total_sales,
                cash_difference: shiftData.cash_difference
            }, 'info');
        }

        function logSystemChange(changeType, oldValue, newValue, description) {
            logActivity('system_change', {
                change_type: changeType,
                old_value: oldValue,
                new_value: newValue,
                description: description
            }, 'warning');
        }

        function logSecurityEvent(eventType, details) {
            logActivity('security_event', {
                event_type: eventType,
                ...details
            }, 'critical');
        }

        function logMenuChange(action, itemData) {
            logActivity(`menu_${action}`, {
                item_id: itemData.id,
                item_name: itemData.name,
                category: itemData.category,
                price: itemData.price
            }, 'info');
        }

        function logSettingsChange(settingName, oldValue, newValue) {
            logActivity('settings_change', {
                setting_name: settingName,
                old_value: oldValue,
                new_value: newValue
            }, 'info');
        }

        // Financial Ledger System
        function recordFinancialEntry(entry) {
            const ledgerEntry = {
                id: Date.now() + Math.random(),
                ...entry,
                created_by: currentUser.username,
                shift_id: currentShift ? currentShift.shift_id : null
            };
            
            financialLedger.push(ledgerEntry);
            saveToDatabase('financial_ledger', ledgerEntry);
            
            console.log(`Financial Entry: ${entry.type.toUpperCase()} ${entry.account} $${entry.amount.toFixed(2)} - ${entry.description}`);
        }

        // Load menu data
        function loadMenuData() {
            displayCategories(categories.map(name => ({ name })));
            displayMenuItems(menuItems);
            updateReceiptDisplays();
        }

        // Display Functions
        function displayCategories(categories) {
            const container = $('#categoriesContainer');
            container.empty();
            
            // Add "All" button
            container.append(`
                <button onclick="loadMenuItems()" class="bg-gray-100 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-200 transition text-sm touch-btn">All</button>
            `);
            
            categories.forEach(category => {
                container.append(`
                    <button onclick="filterByCategory('${category.name}')" class="bg-blue-100 text-blue-800 px-3 py-2 rounded-lg hover:bg-blue-200 transition text-sm touch-btn">${category.name}</button>
                `);
            });
        }

        function displayMenuItems(items) {
            const container = $('#menuItemsContainer');
            container.empty();
            
            items.forEach(item => {
                const deleteBtn = (currentUser && hasPermission('admin')) ? 
                    `<button onclick="event.stopPropagation(); deleteMenuItem(${item.id})" class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full hover:bg-red-600 transition flex items-center justify-center text-sm font-bold touch-btn" title="Delete Item">√ó</button>` : '';
                
                container.append(`
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer border border-gray-200 min-h-32 md:min-h-48 relative hover-card smooth-transition" onclick="selectItem(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                        ${deleteBtn}
                        <div class="text-center">
                            ${item.image ? `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 md:w-20 md:h-20 mx-auto mb-2 md:mb-3 rounded-lg object-cover" onerror="this.style.display='none';">` : '<div class="w-12 h-12 md:w-20 md:h-20 mx-auto mb-2 md:mb-3 bg-gray-200 rounded-lg flex items-center justify-center text-xl md:text-3xl">‚òï</div>'}
                            <h3 class="font-semibold text-gray-800 mb-1 md:mb-2 text-sm md:text-base">${item.name}</h3>
                            <p class="text-xs md:text-sm text-gray-600 mb-1 md:mb-2">${item.category}</p>
                            <p class="text-sm md:text-lg font-bold text-green-600">$${parseFloat(item.price).toFixed(2)}</p>
                        </div>
                    </div>
                `);
            });
        }

        function filterByCategory(category) {
            const filteredItems = menuItems.filter(item => item.category === category);
            displayMenuItems(filteredItems);
        }

        function loadMenuItems() {
            displayMenuItems(menuItems);
        }

        // Item Selection and Order Management
        function selectItem(item) {
            currentItem = item;
            selectedQuantity = 1;
            
            if (item.category === 'Coffee' || item.category === 'Tea') {
                document.getElementById('sugarModal').classList.remove('hidden');
            } else {
                currentSugarOption = 'N/A';
                showQuantityModal();
            }
        }

        function selectSugarOption(sugarOption) {
            currentSugarOption = sugarOption;
            closeModal('sugarModal');
            showQuantityModal();
        }

        function showQuantityModal() {
            document.getElementById('quantityItemName').textContent = currentItem.name;
            document.getElementById('quantityItemPrice').textContent = `$${parseFloat(currentItem.price).toFixed(2)} each`;
            document.getElementById('quantityItemSugar').textContent = currentSugarOption !== 'N/A' ? currentSugarOption : 'No sugar option';
            
            document.getElementById('selectedQuantity').textContent = selectedQuantity;
            updateTotalPrice();
            
            document.getElementById('quantityModal').classList.remove('hidden');
        }

        function changeQuantity(change) {
            selectedQuantity = Math.max(1, selectedQuantity + change);
            document.getElementById('selectedQuantity').textContent = selectedQuantity;
            updateTotalPrice();
        }

        function setQuantity(quantity) {
            selectedQuantity = quantity;
            document.getElementById('selectedQuantity').textContent = selectedQuantity;
            updateTotalPrice();
        }

        function updateTotalPrice() {
            const totalPrice = parseFloat(currentItem.price) * selectedQuantity;
            document.getElementById('totalItemPrice').textContent = `$${totalPrice.toFixed(2)}`;
        }

        function confirmAddToOrder() {
            addToOrder(currentItem, currentSugarOption, selectedQuantity);
            closeModal('quantityModal');
        }

        function addToOrder(item, sugarOption, quantity = 1) {
            const existingItem = currentOrder.find(oi => oi.name === item.name && oi.sugarOption === sugarOption);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const orderItem = {
                    id: Date.now(),
                    name: item.name,
                    price: parseFloat(item.price),
                    sugarOption: sugarOption,
                    quantity: quantity
                };
                currentOrder.push(orderItem);
            }
            
            updateOrderDisplay();
            updateCartItemCount();
        }

        function removeFromOrder(itemId) {
            currentOrder = currentOrder.filter(item => item.id !== itemId);
            updateOrderDisplay();
            updateCartItemCount();
        }

        function updateOrderDisplay() {
            // Update desktop order display
            const container = $('#orderItems');
            container.empty();
            
            if (currentOrder.length === 0) {
                container.html('<p class="text-gray-500 text-center py-4">No items in order</p>');
            } else {
                currentOrder.forEach(item => {
                    container.append(`
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-medium">${item.name}</h4>
                                <p class="text-sm text-gray-600">${item.sugarOption !== 'N/A' ? item.sugarOption : ''}</p>
                                <div class="flex items-center space-x-2 mt-2">
                                    <button onclick="changeOrderItemQuantity(${item.id}, -1)" class="bg-red-500 text-white w-6 h-6 rounded-full hover:bg-red-600 transition text-xs font-bold touch-btn">-</button>
                                    <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                                    <button onclick="changeOrderItemQuantity(${item.id}, 1)" class="bg-green-500 text-white w-6 h-6 rounded-full hover:bg-green-600 transition text-xs font-bold touch-btn">+</button>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${(item.price * item.quantity).toFixed(2)}</p>
                                <button onclick="removeFromOrder(${item.id})" class="text-red-500 hover:text-red-700 text-sm touch-btn">Remove</button>
                            </div>
                        </div>
                    `);
                });
            }
            
            updateTotal();
            
            // Update mobile order display if cart is open
            if (isMobileCartOpen) {
                updateMobileOrderDisplay();
            }
        }

        function changeOrderItemQuantity(itemId, change) {
            const item = currentOrder.find(i => i.id === itemId);
            if (item) {
                item.quantity = Math.max(1, item.quantity + change);
                updateOrderDisplay();
                updateCartItemCount();
            }
        }

        function updateTotal() {
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountAmount = subtotal * (discountPercent / 100);
            const total = Math.max(0, subtotal - discountAmount);
            const totalKHR = Math.round(total * systemSettings.exchangeRate);
            
            document.getElementById('orderTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('orderTotalKHR').textContent = `·üõ${totalKHR.toLocaleString()}`;
            
            const discountInfo = document.getElementById('discountInfo');
            if (discountAmount > 0) {
                discountInfo.style.display = 'block';
                discountInfo.textContent = `Discount ${discountPercent}%: -$${discountAmount.toFixed(2)} (-·üõ${Math.round(discountAmount * systemSettings.exchangeRate).toLocaleString()})`;
            } else {
                discountInfo.style.display = 'none';
            }
        }

        // Discount Functions
        function applyDiscount(percent) {
            discountPercent = percent;
            updateTotal();
            updateMobileTotal();
        }

        function showCustomDiscount() {
            const customPercent = prompt('Enter discount percentage (0-100):');
            if (customPercent !== null && !isNaN(customPercent)) {
                const percent = Math.max(0, Math.min(100, parseFloat(customPercent)));
                applyDiscount(percent);
            }
        }

        function removeDiscount() {
            discountPercent = 0;
            updateTotal();
            updateMobileTotal();
        }

        // Transaction Processing
        function processPayment(paymentType) {
            if (currentOrder.length === 0) {
                alert('No items in order');
                return;
            }
            
            // Check if receipt counter exceeds 100 for current shift
            if (currentShift && receiptCounter > 100) {
                alert('Receipt limit reached for this shift (100 receipts maximum).\nPlease close current shift and start a new one.');
                return;
            }
            
            const subtotal = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const discountAmount = subtotal * (discountPercent / 100);
            const total = Math.max(0, subtotal - discountAmount);
            
            const receiptNumber = String(receiptCounter).padStart(3, '0');
            
            // Create transaction record
            const transaction = {
                receipt_number: receiptNumber,
                items: [...currentOrder],
                subtotal: subtotal,
                discount_percent: discountPercent,
                discount_amount: discountAmount,
                total: total,
                payment_type: paymentType,
                cashier: currentUser.username,
                timestamp: new Date().toISOString(),
                voided: false
            };
            
            // Add to transaction history
            transactionHistory.push(transaction);
            
            // Log transaction
            logTransaction(transaction, 'created');
            
            // Update current shift data if shift is open
            if (currentShift) {
                currentShift.transactions.push(transaction.receipt_number);
                currentShift.total_sales += total;
                currentShift.total_transactions += 1;
                currentShift.payment_breakdown[paymentType] += total;
            }
            
            // Record financial entries
            recordFinancialEntry({
                type: 'debit',
                account: paymentType === 'Cash' ? 'Cash' : 'QR_Payments',
                amount: total,
                description: `Sale - Receipt #${receiptNumber}`,
                reference: receiptNumber,
                timestamp: transaction.timestamp
            });
            
            recordFinancialEntry({
                type: 'credit',
                account: 'Sales_Revenue',
                amount: total,
                description: `Sale - Receipt #${receiptNumber}`,
                reference: receiptNumber,
                timestamp: transaction.timestamp
            });
            
            // Save to database
            saveToDatabase('transactions', transaction);
            
            // Show receipt modal
            showReceiptModal(transaction);
            
            // Reset order
            currentOrder = [];
            discountPercent = 0;
            updateOrderDisplay();
            updateReceiptNumber();
            updateCartItemCount();
            
            // Close mobile cart
            if (isMobileCartOpen) {
                toggleMobileCart();
            }
        }

        // Receipt Functions
        function showReceiptModal(transaction) {
            generateReceiptHTML(transaction);
            document.getElementById('receiptModal').classList.remove('hidden');
        }

        function generateReceiptHTML(transaction) {
            const receiptPreview = document.getElementById('receiptPreview');
            const date = new Date(transaction.timestamp);
            
            let receiptHTML = `
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">‚òï</div>
                    <div class="font-bold text-lg">${systemSettings.businessName}</div>
                    <div class="text-sm">${systemSettings.businessAddress}</div>
                </div>
                
                <div class="border-t border-b border-dashed py-2 mb-2">
                    <div class="flex justify-between text-sm">
                        <span>Receipt #${transaction.receipt_number}</span>
                        <span>${date.toLocaleDateString()}</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span>Cashier: ${transaction.cashier}</span>
                        <span>${date.toLocaleTimeString()}</span>
                    </div>
                    <div class="text-sm">Payment: ${transaction.payment_type}</div>
                </div>
                
                <div class="mb-4">
            `;
            
            // Add items
            transaction.items.forEach(item => {
                const itemTotal = item.price * item.quantity;
                
                receiptHTML += `
                    <div class="flex justify-between text-sm mb-1">
                        <div class="flex-1">
                            <div>${item.name}</div>
                            ${item.sugarOption !== 'N/A' ? `<div class="text-xs text-gray-600">${item.sugarOption}</div>` : ''}
                            <div class="text-xs">${item.quantity} x $${item.price.toFixed(2)}</div>
                        </div>
                        <div class="text-right">
                            <div>$${itemTotal.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
            
            receiptHTML += `
                </div>
                
                <div class="border-t border-dashed pt-2">
                    <div class="flex justify-between text-sm">
                        <span>Subtotal:</span>
                        <span>$${transaction.subtotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600">
                        <span>KHR Subtotal:</span>
                        <span>·üõ${Math.round(transaction.subtotal * systemSettings.exchangeRate).toLocaleString()}</span>
                    </div>
            `;
            
            if (transaction.discount_amount > 0) {
                receiptHTML += `
                    <div class="flex justify-between text-sm text-green-600">
                        <span>Discount (${transaction.discount_percent}%):</span>
                        <span>-$${transaction.discount_amount.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-xs text-green-600">
                        <span>KHR Discount:</span>
                        <span>-·üõ${Math.round(transaction.discount_amount * systemSettings.exchangeRate).toLocaleString()}</span>
                    </div>
                `;
            }
            
            receiptHTML += `
                    <div class="flex justify-between font-bold border-t mt-2 pt-2">
                        <span>TOTAL:</span>
                        <span>$${transaction.total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between font-bold text-sm text-blue-600">
                        <span>KHR TOTAL:</span>
                        <span>·üõ${Math.round(transaction.total * systemSettings.exchangeRate).toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="text-center text-xs mt-4 border-t border-dashed pt-2">
                    <div class="mb-2">Thank you for your visit!</div>
                    <div class="mb-1">Exchange Rate: 1 USD = ·üõ${systemSettings.exchangeRate.toLocaleString()}</div>
                    <div class="mb-1">WiFi: ${systemSettings.wifiName}</div>
                    <div>Password: ${systemSettings.wifiPassword}</div>
                </div>
            `;
            
            receiptPreview.innerHTML = receiptHTML;
        }

        function printReceipt() {
            const receiptContent = document.getElementById('receiptPreview').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Receipt</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                font-size: 12px;
                                width: 80mm;
                                margin: 0;
                                padding: 10px;
                            }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .font-bold { font-weight: bold; }
                            .text-sm { font-size: 0.9em; }
                            .text-xs { font-size: 0.8em; }
                            .text-lg { font-size: 1.2em; }
                            .border-t { border-top: 1px solid #000; }
                            .border-b { border-bottom: 1px solid #000; }
                            .border-dashed { border-style: dashed; }
                            .mb-1 { margin-bottom: 0.25rem; }
                            .mb-2 { margin-bottom: 0.5rem; }
                            .mb-4 { margin-bottom: 1rem; }
                            .mt-2 { margin-top: 0.5rem; }
                            .mt-4 { margin-top: 1rem; }
                            .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
                            .pt-2 { padding-top: 0.5rem; }
                            .flex { display: flex; }
                            .justify-between { justify-content: space-between; }
                            .flex-1 { flex: 1; }
                            .text-gray-600 { color: #666; }
                            .text-green-600 { color: #059669; }
                        </style>
                    </head>
                    <body>
                        ${receiptContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        }

        // Reports Functions (simplified for mobile)
        function showReports() {
            // Set default date range (last 30 days)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('reportFromDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
            
            document.getElementById('reportsModal').classList.remove('hidden');
            
            // Auto-generate the current report tab
            generateReport();
        }

        function showReportTab(tabName) {
            currentReportType = tabName;
            
            // Hide all tabs
            document.querySelectorAll('.report-tab').forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(tabName + 'Report').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('[id$="ReportTab"]').forEach(btn => {
                btn.className = 'flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm';
            });
            
            document.getElementById(tabName + 'ReportTab').className = 'flex-shrink-0 py-2 px-3 md:px-4 rounded-md bg-white text-blue-600 font-medium text-sm';
            
            // Auto-generate report for the selected tab
            generateReport();
        }

        // Auto Report Generation Functions
        function handleAutoReportSelection() {
            const autoType = document.getElementById('autoReportType').value;
            if (autoType) {
                setQuickDateRange(autoType);
                // Auto-generate report after setting dates
                setTimeout(() => {
                    generateReport();
                }, 100);
            }
        }

        function setQuickDateRange(period) {
            const today = new Date();
            let fromDate, toDate;
            
            switch (period) {
                case 'today':
                    fromDate = toDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    fromDate = toDate = yesterday.toISOString().split('T')[0];
                    break;
                    
                case 'this_week':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    fromDate = startOfWeek.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'last_week':
                    const lastWeekEnd = new Date(today);
                    lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                    const lastWeekStart = new Date(lastWeekEnd);
                    lastWeekStart.setDate(lastWeekEnd.getDate() - 6);
                    fromDate = lastWeekStart.toISOString().split('T')[0];
                    toDate = lastWeekEnd.toISOString().split('T')[0];
                    break;
                    
                case 'this_month':
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    fromDate = startOfMonth.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'last_month':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    fromDate = lastMonth.toISOString().split('T')[0];
                    toDate = lastMonthEnd.toISOString().split('T')[0];
                    break;
                    
                case 'last_7_days':
                    const sevenDaysAgo = new Date(today);
                    sevenDaysAgo.setDate(today.getDate() - 7);
                    fromDate = sevenDaysAgo.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'last_30_days':
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    fromDate = thirtyDaysAgo.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'last_90_days':
                    const ninetyDaysAgo = new Date(today);
                    ninetyDaysAgo.setDate(today.getDate() - 90);
                    fromDate = ninetyDaysAgo.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                    
                case 'this_year':
                    const startOfYear = new Date(today.getFullYear(), 0, 1);
                    fromDate = startOfYear.toISOString().split('T')[0];
                    toDate = today.toISOString().split('T')[0];
                    break;
                    
                default:
                    return;
            }
            
            document.getElementById('reportFromDate').value = fromDate;
            document.getElementById('reportToDate').value = toDate;
            
            // Reset auto report dropdown
            document.getElementById('autoReportType').value = '';
        }

        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const paymentType = document.getElementById('reportPaymentType').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            // Filter transactions based on criteria
            let filteredTransactions = transactionHistory.filter(t => {
                const transactionDate = new Date(t.timestamp).toISOString().split('T')[0];
                const dateInRange = transactionDate >= fromDate && transactionDate <= toDate;
                const paymentMatch = !paymentType || t.payment_type === paymentType;
                const notVoided = !t.voided;
                
                return dateInRange && paymentMatch && notVoided;
            });
            
            currentReportData = filteredTransactions;
            
            // Log report generation
            logActivity('report_generated', {
                report_type: currentReportType,
                date_range: `${fromDate} to ${toDate}`,
                payment_filter: paymentType || 'all',
                transactions_found: filteredTransactions.length,
                total_value: filteredTransactions.reduce((sum, t) => sum + t.total, 0)
            }, 'info');
            
            // Generate different reports based on current tab
            if (currentReportType === 'sales') {
                generateSalesReport(filteredTransactions);
            } else if (currentReportType === 'items') {
                generateItemsReport(filteredTransactions);
            } else if (currentReportType === 'slow') {
                generateSlowItemsReport(filteredTransactions);
            } else if (currentReportType === 'void') {
                generateVoidReport(fromDate, toDate);
            } else if (currentReportType === 'shifts') {
                generateShiftsReport(fromDate, toDate);
            } else if (currentReportType === 'financial') {
                generateFinancialReport(fromDate, toDate);
            } else if (currentReportType === 'activity') {
                generateActivityReport(fromDate, toDate);
            } else if (currentReportType === 'backup') {
                generateBackupReport();
            }
        }

        function generateSalesReport(transactions) {
            const container = document.getElementById('salesReportContent');
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found for the selected period</p>';
                return;
            }
            
            // Calculate summary statistics
            const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalTransactions = transactions.length;
            const totalDiscounts = transactions.reduce((sum, t) => sum + t.discount_amount, 0);
            const averageTransaction = totalSales / totalTransactions;
            
            // Payment type breakdown
            const paymentBreakdown = {};
            transactions.forEach(t => {
                paymentBreakdown[t.payment_type] = (paymentBreakdown[t.payment_type] || 0) + t.total;
            });
            
            let reportHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">$${totalSales.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Sales</div>
                        <div class="text-xs text-gray-600">·üõ${Math.round(totalSales * systemSettings.exchangeRate).toLocaleString()}</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${totalTransactions}</div>
                        <div class="text-xs md:text-sm text-green-800">Transactions</div>
                    </div>
                    <div class="bg-purple-50 p-3 md:p-4 rounded-lg text-center">
                        <div class="text-lg md:text-2xl font-bold text-purple-600">$${averageTransaction.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-purple-800">Avg Transaction</div>
                    </div>
                    <div class="bg-orange-50 p-3 md:p-4 rounded-lg text-center">
                        <div class="text-lg md:text-2xl font-bold text-orange-600">$${totalDiscounts.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-orange-800">Total Discounts</div>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-3">Payment Methods</h4>
                    <div class="space-y-2">
            `;
            
            Object.entries(paymentBreakdown).forEach(([method, amount]) => {
                const percentage = ((amount / totalSales) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <span class="text-sm md:text-base">${method}</span>
                        <div class="text-right">
                            <div class="font-medium">$${amount.toFixed(2)}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateActivityReport(fromDate, toDate) {
            const container = document.getElementById('activityReportContent');
            
            // Filter activity log based on date range
            let filteredActivities = activityLog.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity found for the selected period</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Calculate summary statistics
            const totalActivities = filteredActivities.length;
            const uniqueUsers = [...new Set(filteredActivities.map(a => a.user))].length;
            const activityTypes = {};
            const levelCounts = { info: 0, warning: 0, error: 0, critical: 0 };
            
            filteredActivities.forEach(activity => {
                activityTypes[activity.action] = (activityTypes[activity.action] || 0) + 1;
                levelCounts[activity.level] = (levelCounts[activity.level] || 0) + 1;
            });
            
            // Get top activities
            const topActivities = Object.entries(activityTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            let reportHTML = `
                <!-- Activity Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalActivities}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Activities</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${uniqueUsers}</div>
                        <div class="text-xs md:text-sm text-green-800">Active Users</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">${levelCounts.warning + levelCounts.error}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Warnings/Errors</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">${levelCounts.critical}</div>
                        <div class="text-xs md:text-sm text-red-800">Critical Events</div>
                    </div>
                </div>
                
                <!-- Activity Level Breakdown -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üìä Activity Levels</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ÑπÔ∏è</div>
                            <div class="font-bold text-blue-600">${levelCounts.info}</div>
                            <div class="text-xs text-gray-600">Info</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                            <div class="font-bold text-yellow-600">${levelCounts.warning}</div>
                            <div class="text-xs text-gray-600">Warning</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <div class="font-bold text-red-600">${levelCounts.error}</div>
                            <div class="text-xs text-gray-600">Error</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">üö®</div>
                            <div class="font-bold text-red-800">${levelCounts.critical}</div>
                            <div class="text-xs text-gray-600">Critical</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Activities -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üî• Most Common Activities</h4>
                    <div class="space-y-2">
            `;
            
            topActivities.forEach(([activity, count], index) => {
                const percentage = ((count / totalActivities) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">#${index + 1}</span>
                            <span class="text-sm">${activity.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${count}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
                
                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h4 class="font-semibold">üìù Recent Activity Log</h4>
                        <div class="text-sm text-gray-600">Showing last 50 entries</div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Time</th>
                                    <th class="px-2 md:px-4 py-2 text-left">User</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Action</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Level</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show only last 50 entries for performance
            const recentActivities = filteredActivities.slice(0, 50);
            
            recentActivities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                const levelColors = {
                    'info': 'text-blue-600 bg-blue-50',
                    'warning': 'text-yellow-600 bg-yellow-50',
                    'error': 'text-red-600 bg-red-50',
                    'critical': 'text-red-800 bg-red-100'
                };
                
                const levelEmojis = {
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                
                // Format details for display
                let detailsText = '';
                if (activity.details && Object.keys(activity.details).length > 0) {
                    const keyDetails = [];
                    if (activity.details.receipt_number) keyDetails.push(`Receipt: ${activity.details.receipt_number}`);
                    if (activity.details.total) keyDetails.push(`$${activity.details.total}`);
                    if (activity.details.shift_id) keyDetails.push(`Shift: ${activity.details.shift_id}`);
                    if (activity.details.username) keyDetails.push(`User: ${activity.details.username}`);
                    if (activity.details.success !== undefined) keyDetails.push(activity.details.success ? 'Success' : 'Failed');
                    
                    detailsText = keyDetails.join(', ') || 'See console for full details';
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs font-medium">${date.toLocaleTimeString()}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.user}</div>
                            <div class="text-xs text-gray-500">${activity.user_role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.action.replace(/_/g, ' ')}</div>
                            ${activity.shift_id ? `<div class="text-xs text-gray-500">${activity.shift_id}</div>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${levelColors[activity.level]}">
                                ${levelEmojis[activity.level]} ${activity.level}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs text-gray-600 max-w-xs truncate" title="${detailsText}">
                                ${detailsText}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Activity Log Tips -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Activity Log Usage Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Security Monitoring:</strong> Watch for failed login attempts and critical events</div>
                        <div>‚Ä¢ <strong>User Behavior:</strong> Track which users perform which actions most frequently</div>
                        <div>‚Ä¢ <strong>System Health:</strong> Monitor error and warning levels for system issues</div>
                        <div>‚Ä¢ <strong>Audit Trail:</strong> Complete record of all system activities for compliance</div>
                        <div>‚Ä¢ <strong>Performance:</strong> Identify peak activity times and user patterns</div>
                        <div>‚Ä¢ <strong>Training:</strong> Use activity patterns to identify training needs</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateItemsReport(transactions) {
            const container = document.getElementById('itemsReportContent');
            
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No transactions found for the selected period</p>';
                return;
            }
            
            // Aggregate item sales
            const itemSales = {};
            transactions.forEach(t => {
                t.items.forEach(item => {
                    const key = item.name;
                    if (!itemSales[key]) {
                        itemSales[key] = {
                            name: item.name,
                            quantity: 0,
                            revenue: 0,
                            category: menuItems.find(mi => mi.name === item.name)?.category || 'Unknown'
                        };
                    }
                    itemSales[key].quantity += item.quantity;
                    itemSales[key].revenue += item.price * item.quantity;
                });
            });
            
            // Sort by revenue (highest first)
            const sortedItems = Object.values(itemSales).sort((a, b) => b.revenue - a.revenue);
            
            let reportHTML = `
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold">Item Performance Ranking</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Rank</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Item</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Qty</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            sortedItems.forEach((item, index) => {
                const rankClass = index < 3 ? 'bg-yellow-50' : '';
                const rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                
                reportHTML += `
                    <tr class="${rankClass}">
                        <td class="px-2 md:px-4 py-2 font-medium text-xs md:text-sm">${rankIcon} #${index + 1}</td>
                        <td class="px-2 md:px-4 py-2 text-xs md:text-sm">${item.name}</td>
                        <td class="px-2 md:px-4 py-2 text-right font-medium text-xs md:text-sm">${item.quantity}</td>
                        <td class="px-2 md:px-4 py-2 text-right font-medium text-green-600 text-xs md:text-sm">$${item.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateActivityReport(fromDate, toDate) {
            const container = document.getElementById('activityReportContent');
            
            // Filter activity log based on date range
            let filteredActivities = activityLog.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity found for the selected period</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Calculate summary statistics
            const totalActivities = filteredActivities.length;
            const uniqueUsers = [...new Set(filteredActivities.map(a => a.user))].length;
            const activityTypes = {};
            const levelCounts = { info: 0, warning: 0, error: 0, critical: 0 };
            
            filteredActivities.forEach(activity => {
                activityTypes[activity.action] = (activityTypes[activity.action] || 0) + 1;
                levelCounts[activity.level] = (levelCounts[activity.level] || 0) + 1;
            });
            
            // Get top activities
            const topActivities = Object.entries(activityTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            let reportHTML = `
                <!-- Activity Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalActivities}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Activities</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${uniqueUsers}</div>
                        <div class="text-xs md:text-sm text-green-800">Active Users</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">${levelCounts.warning + levelCounts.error}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Warnings/Errors</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">${levelCounts.critical}</div>
                        <div class="text-xs md:text-sm text-red-800">Critical Events</div>
                    </div>
                </div>
                
                <!-- Activity Level Breakdown -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üìä Activity Levels</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ÑπÔ∏è</div>
                            <div class="font-bold text-blue-600">${levelCounts.info}</div>
                            <div class="text-xs text-gray-600">Info</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                            <div class="font-bold text-yellow-600">${levelCounts.warning}</div>
                            <div class="text-xs text-gray-600">Warning</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <div class="font-bold text-red-600">${levelCounts.error}</div>
                            <div class="text-xs text-gray-600">Error</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">üö®</div>
                            <div class="font-bold text-red-800">${levelCounts.critical}</div>
                            <div class="text-xs text-gray-600">Critical</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Activities -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üî• Most Common Activities</h4>
                    <div class="space-y-2">
            `;
            
            topActivities.forEach(([activity, count], index) => {
                const percentage = ((count / totalActivities) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">#${index + 1}</span>
                            <span class="text-sm">${activity.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${count}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
                
                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h4 class="font-semibold">üìù Recent Activity Log</h4>
                        <div class="text-sm text-gray-600">Showing last 50 entries</div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Time</th>
                                    <th class="px-2 md:px-4 py-2 text-left">User</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Action</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Level</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show only last 50 entries for performance
            const recentActivities = filteredActivities.slice(0, 50);
            
            recentActivities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                const levelColors = {
                    'info': 'text-blue-600 bg-blue-50',
                    'warning': 'text-yellow-600 bg-yellow-50',
                    'error': 'text-red-600 bg-red-50',
                    'critical': 'text-red-800 bg-red-100'
                };
                
                const levelEmojis = {
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                
                // Format details for display
                let detailsText = '';
                if (activity.details && Object.keys(activity.details).length > 0) {
                    const keyDetails = [];
                    if (activity.details.receipt_number) keyDetails.push(`Receipt: ${activity.details.receipt_number}`);
                    if (activity.details.total) keyDetails.push(`$${activity.details.total}`);
                    if (activity.details.shift_id) keyDetails.push(`Shift: ${activity.details.shift_id}`);
                    if (activity.details.username) keyDetails.push(`User: ${activity.details.username}`);
                    if (activity.details.success !== undefined) keyDetails.push(activity.details.success ? 'Success' : 'Failed');
                    
                    detailsText = keyDetails.join(', ') || 'See console for full details';
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs font-medium">${date.toLocaleTimeString()}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.user}</div>
                            <div class="text-xs text-gray-500">${activity.user_role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.action.replace(/_/g, ' ')}</div>
                            ${activity.shift_id ? `<div class="text-xs text-gray-500">${activity.shift_id}</div>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${levelColors[activity.level]}">
                                ${levelEmojis[activity.level]} ${activity.level}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs text-gray-600 max-w-xs truncate" title="${detailsText}">
                                ${detailsText}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Activity Log Tips -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Activity Log Usage Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Security Monitoring:</strong> Watch for failed login attempts and critical events</div>
                        <div>‚Ä¢ <strong>User Behavior:</strong> Track which users perform which actions most frequently</div>
                        <div>‚Ä¢ <strong>System Health:</strong> Monitor error and warning levels for system issues</div>
                        <div>‚Ä¢ <strong>Audit Trail:</strong> Complete record of all system activities for compliance</div>
                        <div>‚Ä¢ <strong>Performance:</strong> Identify peak activity times and user patterns</div>
                        <div>‚Ä¢ <strong>Training:</strong> Use activity patterns to identify training needs</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateSlowItemsReport(transactions) {
            const container = document.getElementById('slowReportContent');
            
            // Get all menu items and their sales data
            const itemSales = {};
            
            // Initialize all menu items with zero sales
            menuItems.forEach(item => {
                itemSales[item.name] = {
                    name: item.name,
                    category: item.category,
                    price: item.price,
                    quantity: 0,
                    revenue: 0,
                    lastSold: null
                };
            });
            
            // Add actual sales data
            transactions.forEach(t => {
                t.items.forEach(item => {
                    if (itemSales[item.name]) {
                        itemSales[item.name].quantity += item.quantity;
                        itemSales[item.name].revenue += item.price * item.quantity;
                        itemSales[item.name].lastSold = t.timestamp;
                    }
                });
            });
            
            // Sort by quantity sold (lowest first)
            const sortedItems = Object.values(itemSales).sort((a, b) => a.quantity - b.quantity);
            
            // Calculate average sales for comparison
            const totalQuantity = sortedItems.reduce((sum, item) => sum + item.quantity, 0);
            const averageQuantity = totalQuantity / sortedItems.length;
            
            let reportHTML = `
                <div class="mb-4 p-3 md:p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                    <h4 class="font-semibold text-yellow-800 mb-2">üìä Slow Moving Items Analysis</h4>
                    <p class="text-sm text-yellow-700">Items with sales below average (${averageQuantity.toFixed(1)} units) are highlighted.</p>
                </div>
                
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold">Items by Performance</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Status</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Item</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Qty</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Revenue</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            sortedItems.forEach((item, index) => {
                const isSlowMover = item.quantity < averageQuantity;
                const isZeroSales = item.quantity === 0;
                const rowClass = isZeroSales ? 'bg-red-50' : isSlowMover ? 'bg-yellow-50' : 'bg-green-50';
                
                let statusIcon;
                if (isZeroSales) {
                    statusIcon = 'üî¥';
                } else if (isSlowMover) {
                    statusIcon = 'üü°';
                } else {
                    statusIcon = 'üü¢';
                }
                
                reportHTML += `
                    <tr class="${rowClass}">
                        <td class="px-2 md:px-4 py-2 text-center">${statusIcon}</td>
                        <td class="px-2 md:px-4 py-2 font-medium text-xs md:text-sm">${item.name}</td>
                        <td class="px-2 md:px-4 py-2 text-right font-medium text-xs md:text-sm">${item.quantity}</td>
                        <td class="px-2 md:px-4 py-2 text-right font-medium text-xs md:text-sm">$${item.revenue.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateActivityReport(fromDate, toDate) {
            const container = document.getElementById('activityReportContent');
            
            // Filter activity log based on date range
            let filteredActivities = activityLog.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity found for the selected period</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Calculate summary statistics
            const totalActivities = filteredActivities.length;
            const uniqueUsers = [...new Set(filteredActivities.map(a => a.user))].length;
            const activityTypes = {};
            const levelCounts = { info: 0, warning: 0, error: 0, critical: 0 };
            
            filteredActivities.forEach(activity => {
                activityTypes[activity.action] = (activityTypes[activity.action] || 0) + 1;
                levelCounts[activity.level] = (levelCounts[activity.level] || 0) + 1;
            });
            
            // Get top activities
            const topActivities = Object.entries(activityTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            let reportHTML = `
                <!-- Activity Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalActivities}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Activities</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${uniqueUsers}</div>
                        <div class="text-xs md:text-sm text-green-800">Active Users</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">${levelCounts.warning + levelCounts.error}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Warnings/Errors</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">${levelCounts.critical}</div>
                        <div class="text-xs md:text-sm text-red-800">Critical Events</div>
                    </div>
                </div>
                
                <!-- Activity Level Breakdown -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üìä Activity Levels</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ÑπÔ∏è</div>
                            <div class="font-bold text-blue-600">${levelCounts.info}</div>
                            <div class="text-xs text-gray-600">Info</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                            <div class="font-bold text-yellow-600">${levelCounts.warning}</div>
                            <div class="text-xs text-gray-600">Warning</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <div class="font-bold text-red-600">${levelCounts.error}</div>
                            <div class="text-xs text-gray-600">Error</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">üö®</div>
                            <div class="font-bold text-red-800">${levelCounts.critical}</div>
                            <div class="text-xs text-gray-600">Critical</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Activities -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üî• Most Common Activities</h4>
                    <div class="space-y-2">
            `;
            
            topActivities.forEach(([activity, count], index) => {
                const percentage = ((count / totalActivities) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">#${index + 1}</span>
                            <span class="text-sm">${activity.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${count}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
                
                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h4 class="font-semibold">üìù Recent Activity Log</h4>
                        <div class="text-sm text-gray-600">Showing last 50 entries</div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Time</th>
                                    <th class="px-2 md:px-4 py-2 text-left">User</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Action</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Level</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show only last 50 entries for performance
            const recentActivities = filteredActivities.slice(0, 50);
            
            recentActivities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                const levelColors = {
                    'info': 'text-blue-600 bg-blue-50',
                    'warning': 'text-yellow-600 bg-yellow-50',
                    'error': 'text-red-600 bg-red-50',
                    'critical': 'text-red-800 bg-red-100'
                };
                
                const levelEmojis = {
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                
                // Format details for display
                let detailsText = '';
                if (activity.details && Object.keys(activity.details).length > 0) {
                    const keyDetails = [];
                    if (activity.details.receipt_number) keyDetails.push(`Receipt: ${activity.details.receipt_number}`);
                    if (activity.details.total) keyDetails.push(`$${activity.details.total}`);
                    if (activity.details.shift_id) keyDetails.push(`Shift: ${activity.details.shift_id}`);
                    if (activity.details.username) keyDetails.push(`User: ${activity.details.username}`);
                    if (activity.details.success !== undefined) keyDetails.push(activity.details.success ? 'Success' : 'Failed');
                    
                    detailsText = keyDetails.join(', ') || 'See console for full details';
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs font-medium">${date.toLocaleTimeString()}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.user}</div>
                            <div class="text-xs text-gray-500">${activity.user_role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.action.replace(/_/g, ' ')}</div>
                            ${activity.shift_id ? `<div class="text-xs text-gray-500">${activity.shift_id}</div>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${levelColors[activity.level]}">
                                ${levelEmojis[activity.level]} ${activity.level}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs text-gray-600 max-w-xs truncate" title="${detailsText}">
                                ${detailsText}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Activity Log Tips -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Activity Log Usage Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Security Monitoring:</strong> Watch for failed login attempts and critical events</div>
                        <div>‚Ä¢ <strong>User Behavior:</strong> Track which users perform which actions most frequently</div>
                        <div>‚Ä¢ <strong>System Health:</strong> Monitor error and warning levels for system issues</div>
                        <div>‚Ä¢ <strong>Audit Trail:</strong> Complete record of all system activities for compliance</div>
                        <div>‚Ä¢ <strong>Performance:</strong> Identify peak activity times and user patterns</div>
                        <div>‚Ä¢ <strong>Training:</strong> Use activity patterns to identify training needs</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateVoidReport(fromDate, toDate) {
            const container = document.getElementById('voidReportContent');
            
            // Filter void history based on date range
            let filteredVoids = voidHistory.filter(v => {
                const voidDate = new Date(v.void_timestamp).toISOString().split('T')[0];
                return voidDate >= fromDate && voidDate <= toDate;
            });
            
            if (filteredVoids.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No void transactions found for the selected period</p>';
                return;
            }
            
            // Calculate summary statistics
            const totalVoidAmount = filteredVoids.reduce((sum, v) => sum + v.void_amount, 0);
            const totalVoidCount = filteredVoids.length;
            
            let reportHTML = `
                <div class="grid grid-cols-2 gap-3 md:gap-4 mb-6">
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">$${totalVoidAmount.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-red-800">Total Void Amount</div>
                    </div>
                    <div class="bg-orange-50 p-3 md:p-4 rounded-lg text-center border border-orange-200">
                        <div class="text-lg md:text-2xl font-bold text-orange-600">${totalVoidCount}</div>
                        <div class="text-xs md:text-sm text-orange-800">Void Transactions</div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold">Void Details</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Void ID</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Receipt</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Amount</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Reason</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Sort by void timestamp (newest first)
            filteredVoids.sort((a, b) => new Date(b.void_timestamp) - new Date(a.void_timestamp));
            
            filteredVoids.forEach(voidRecord => {
                reportHTML += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 md:px-4 py-2 font-medium text-red-600 text-xs md:text-sm">${voidRecord.void_id}</td>
                        <td class="px-2 md:px-4 py-2 text-xs md:text-sm">#${voidRecord.original_receipt}</td>
                        <td class="px-2 md:px-4 py-2 text-right font-medium text-red-600 text-xs md:text-sm">$${voidRecord.void_amount.toFixed(2)}</td>
                        <td class="px-2 md:px-4 py-2 text-xs md:text-sm">${voidRecord.void_reason}</td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateActivityReport(fromDate, toDate) {
            const container = document.getElementById('activityReportContent');
            
            // Filter activity log based on date range
            let filteredActivities = activityLog.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity found for the selected period</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Calculate summary statistics
            const totalActivities = filteredActivities.length;
            const uniqueUsers = [...new Set(filteredActivities.map(a => a.user))].length;
            const activityTypes = {};
            const levelCounts = { info: 0, warning: 0, error: 0, critical: 0 };
            
            filteredActivities.forEach(activity => {
                activityTypes[activity.action] = (activityTypes[activity.action] || 0) + 1;
                levelCounts[activity.level] = (levelCounts[activity.level] || 0) + 1;
            });
            
            // Get top activities
            const topActivities = Object.entries(activityTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            let reportHTML = `
                <!-- Activity Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalActivities}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Activities</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${uniqueUsers}</div>
                        <div class="text-xs md:text-sm text-green-800">Active Users</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">${levelCounts.warning + levelCounts.error}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Warnings/Errors</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">${levelCounts.critical}</div>
                        <div class="text-xs md:text-sm text-red-800">Critical Events</div>
                    </div>
                </div>
                
                <!-- Activity Level Breakdown -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üìä Activity Levels</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ÑπÔ∏è</div>
                            <div class="font-bold text-blue-600">${levelCounts.info}</div>
                            <div class="text-xs text-gray-600">Info</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                            <div class="font-bold text-yellow-600">${levelCounts.warning}</div>
                            <div class="text-xs text-gray-600">Warning</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <div class="font-bold text-red-600">${levelCounts.error}</div>
                            <div class="text-xs text-gray-600">Error</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">üö®</div>
                            <div class="font-bold text-red-800">${levelCounts.critical}</div>
                            <div class="text-xs text-gray-600">Critical</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Activities -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üî• Most Common Activities</h4>
                    <div class="space-y-2">
            `;
            
            topActivities.forEach(([activity, count], index) => {
                const percentage = ((count / totalActivities) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">#${index + 1}</span>
                            <span class="text-sm">${activity.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${count}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
                
                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h4 class="font-semibold">üìù Recent Activity Log</h4>
                        <div class="text-sm text-gray-600">Showing last 50 entries</div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Time</th>
                                    <th class="px-2 md:px-4 py-2 text-left">User</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Action</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Level</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show only last 50 entries for performance
            const recentActivities = filteredActivities.slice(0, 50);
            
            recentActivities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                const levelColors = {
                    'info': 'text-blue-600 bg-blue-50',
                    'warning': 'text-yellow-600 bg-yellow-50',
                    'error': 'text-red-600 bg-red-50',
                    'critical': 'text-red-800 bg-red-100'
                };
                
                const levelEmojis = {
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                
                // Format details for display
                let detailsText = '';
                if (activity.details && Object.keys(activity.details).length > 0) {
                    const keyDetails = [];
                    if (activity.details.receipt_number) keyDetails.push(`Receipt: ${activity.details.receipt_number}`);
                    if (activity.details.total) keyDetails.push(`$${activity.details.total}`);
                    if (activity.details.shift_id) keyDetails.push(`Shift: ${activity.details.shift_id}`);
                    if (activity.details.username) keyDetails.push(`User: ${activity.details.username}`);
                    if (activity.details.success !== undefined) keyDetails.push(activity.details.success ? 'Success' : 'Failed');
                    
                    detailsText = keyDetails.join(', ') || 'See console for full details';
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs font-medium">${date.toLocaleTimeString()}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.user}</div>
                            <div class="text-xs text-gray-500">${activity.user_role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.action.replace(/_/g, ' ')}</div>
                            ${activity.shift_id ? `<div class="text-xs text-gray-500">${activity.shift_id}</div>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${levelColors[activity.level]}">
                                ${levelEmojis[activity.level]} ${activity.level}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs text-gray-600 max-w-xs truncate" title="${detailsText}">
                                ${detailsText}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Activity Log Tips -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Activity Log Usage Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Security Monitoring:</strong> Watch for failed login attempts and critical events</div>
                        <div>‚Ä¢ <strong>User Behavior:</strong> Track which users perform which actions most frequently</div>
                        <div>‚Ä¢ <strong>System Health:</strong> Monitor error and warning levels for system issues</div>
                        <div>‚Ä¢ <strong>Audit Trail:</strong> Complete record of all system activities for compliance</div>
                        <div>‚Ä¢ <strong>Performance:</strong> Identify peak activity times and user patterns</div>
                        <div>‚Ä¢ <strong>Training:</strong> Use activity patterns to identify training needs</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateShiftsReport(fromDate, toDate) {
            const container = document.getElementById('shiftsReportContent');
            
            // Filter shifts based on date range
            let filteredShifts = shiftHistory.filter(shift => {
                const shiftDate = new Date(shift.start_time).toISOString().split('T')[0];
                return shiftDate >= fromDate && shiftDate <= toDate;
            });
            
            // Include current shift if it's within date range and open
            if (currentShift) {
                const currentShiftDate = new Date(currentShift.start_time).toISOString().split('T')[0];
                if (currentShiftDate >= fromDate && currentShiftDate <= toDate) {
                    filteredShifts.push({
                        ...currentShift,
                        status: 'open',
                        end_time: null,
                        duration: 'In Progress'
                    });
                }
            }
            
            if (filteredShifts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No shifts found for the selected period</p>';
                return;
            }
            
            // Sort by start time (newest first)
            filteredShifts.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
            
            // Calculate summary statistics
            const closedShifts = filteredShifts.filter(s => s.status === 'closed');
            const totalShifts = filteredShifts.length;
            const totalSales = filteredShifts.reduce((sum, s) => sum + s.total_sales, 0);
            const totalTransactions = filteredShifts.reduce((sum, s) => sum + s.total_transactions, 0);
            const totalCashOverages = closedShifts.reduce((sum, s) => sum + Math.max(0, s.cash_difference || 0), 0);
            const totalCashShortages = closedShifts.reduce((sum, s) => sum + Math.abs(Math.min(0, s.cash_difference || 0)), 0);
            
            let reportHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalShifts}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Shifts</div>
                        <div class="text-xs text-gray-600">${closedShifts.length} closed, ${totalShifts - closedShifts.length} open</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">$${totalSales.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-green-800">Total Sales</div>
                        <div class="text-xs text-gray-600">${totalTransactions} transactions</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">$${totalCashOverages.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Cash Overages</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">$${totalCashShortages.toFixed(2)}</div>
                        <div class="text-xs md:text-sm text-red-800">Cash Shortages</div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b">
                        <h4 class="font-semibold">Shift Details</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Shift ID</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Cashier</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Duration</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Sales</th>
                                    <th class="px-2 md:px-4 py-2 text-right">Cash Status</th>
                                    <th class="px-2 md:px-4 py-2 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            filteredShifts.forEach(shift => {
                const statusClass = shift.status === 'open' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                const statusIcon = shift.status === 'open' ? 'üü¢' : '‚ö™';
                
                let cashStatusDisplay = 'N/A';
                let cashStatusClass = 'text-gray-600';
                
                if (shift.status === 'closed' && shift.cash_difference !== null) {
                    if (shift.cash_difference === 0) {
                        cashStatusDisplay = '‚úÖ Balanced';
                        cashStatusClass = 'text-green-600';
                    } else if (shift.cash_difference > 0) {
                        cashStatusDisplay = `+$${shift.cash_difference.toFixed(2)}`;
                        cashStatusClass = 'text-yellow-600';
                    } else {
                        cashStatusDisplay = `-$${Math.abs(shift.cash_difference).toFixed(2)}`;
                        cashStatusClass = 'text-red-600';
                    }
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="showShiftDetails('${shift.shift_id}')">
                        <td class="px-2 md:px-4 py-2 font-medium text-blue-600">${shift.shift_id}</td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${shift.cashier_name}</div>
                            <div class="text-xs text-gray-500">${shift.role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div>${shift.duration || 'In Progress'}</div>
                            <div class="text-xs text-gray-500">${new Date(shift.start_time).toLocaleDateString()}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2 text-right">
                            <div class="font-medium">$${shift.total_sales.toFixed(2)}</div>
                            <div class="text-xs text-gray-500">${shift.total_transactions} trans</div>
                        </td>
                        <td class="px-2 md:px-4 py-2 text-right ${cashStatusClass}">
                            <div class="font-medium">${cashStatusDisplay}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2 text-center">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                ${statusIcon} ${shift.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Shift Management Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ Click on any shift row to view detailed breakdown</div>
                        <div>‚Ä¢ Monitor cash differences to identify training needs</div>
                        <div>‚Ä¢ Track average transaction values by cashier</div>
                        <div>‚Ä¢ Review shift durations for scheduling optimization</div>
                        <div>‚Ä¢ Use void patterns to identify potential issues</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateActivityReport(fromDate, toDate) {
            const container = document.getElementById('activityReportContent');
            
            // Filter activity log based on date range
            let filteredActivities = activityLog.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity found for the selected period</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Calculate summary statistics
            const totalActivities = filteredActivities.length;
            const uniqueUsers = [...new Set(filteredActivities.map(a => a.user))].length;
            const activityTypes = {};
            const levelCounts = { info: 0, warning: 0, error: 0, critical: 0 };
            
            filteredActivities.forEach(activity => {
                activityTypes[activity.action] = (activityTypes[activity.action] || 0) + 1;
                levelCounts[activity.level] = (levelCounts[activity.level] || 0) + 1;
            });
            
            // Get top activities
            const topActivities = Object.entries(activityTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            let reportHTML = `
                <!-- Activity Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalActivities}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Activities</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${uniqueUsers}</div>
                        <div class="text-xs md:text-sm text-green-800">Active Users</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">${levelCounts.warning + levelCounts.error}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Warnings/Errors</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">${levelCounts.critical}</div>
                        <div class="text-xs md:text-sm text-red-800">Critical Events</div>
                    </div>
                </div>
                
                <!-- Activity Level Breakdown -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üìä Activity Levels</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ÑπÔ∏è</div>
                            <div class="font-bold text-blue-600">${levelCounts.info}</div>
                            <div class="text-xs text-gray-600">Info</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                            <div class="font-bold text-yellow-600">${levelCounts.warning}</div>
                            <div class="text-xs text-gray-600">Warning</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <div class="font-bold text-red-600">${levelCounts.error}</div>
                            <div class="text-xs text-gray-600">Error</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">üö®</div>
                            <div class="font-bold text-red-800">${levelCounts.critical}</div>
                            <div class="text-xs text-gray-600">Critical</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Activities -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üî• Most Common Activities</h4>
                    <div class="space-y-2">
            `;
            
            topActivities.forEach(([activity, count], index) => {
                const percentage = ((count / totalActivities) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">#${index + 1}</span>
                            <span class="text-sm">${activity.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${count}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
                
                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h4 class="font-semibold">üìù Recent Activity Log</h4>
                        <div class="text-sm text-gray-600">Showing last 50 entries</div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Time</th>
                                    <th class="px-2 md:px-4 py-2 text-left">User</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Action</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Level</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show only last 50 entries for performance
            const recentActivities = filteredActivities.slice(0, 50);
            
            recentActivities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                const levelColors = {
                    'info': 'text-blue-600 bg-blue-50',
                    'warning': 'text-yellow-600 bg-yellow-50',
                    'error': 'text-red-600 bg-red-50',
                    'critical': 'text-red-800 bg-red-100'
                };
                
                const levelEmojis = {
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                
                // Format details for display
                let detailsText = '';
                if (activity.details && Object.keys(activity.details).length > 0) {
                    const keyDetails = [];
                    if (activity.details.receipt_number) keyDetails.push(`Receipt: ${activity.details.receipt_number}`);
                    if (activity.details.total) keyDetails.push(`$${activity.details.total}`);
                    if (activity.details.shift_id) keyDetails.push(`Shift: ${activity.details.shift_id}`);
                    if (activity.details.username) keyDetails.push(`User: ${activity.details.username}`);
                    if (activity.details.success !== undefined) keyDetails.push(activity.details.success ? 'Success' : 'Failed');
                    
                    detailsText = keyDetails.join(', ') || 'See console for full details';
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs font-medium">${date.toLocaleTimeString()}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.user}</div>
                            <div class="text-xs text-gray-500">${activity.user_role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.action.replace(/_/g, ' ')}</div>
                            ${activity.shift_id ? `<div class="text-xs text-gray-500">${activity.shift_id}</div>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${levelColors[activity.level]}">
                                ${levelEmojis[activity.level]} ${activity.level}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs text-gray-600 max-w-xs truncate" title="${detailsText}">
                                ${detailsText}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Activity Log Tips -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Activity Log Usage Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Security Monitoring:</strong> Watch for failed login attempts and critical events</div>
                        <div>‚Ä¢ <strong>User Behavior:</strong> Track which users perform which actions most frequently</div>
                        <div>‚Ä¢ <strong>System Health:</strong> Monitor error and warning levels for system issues</div>
                        <div>‚Ä¢ <strong>Audit Trail:</strong> Complete record of all system activities for compliance</div>
                        <div>‚Ä¢ <strong>Performance:</strong> Identify peak activity times and user patterns</div>
                        <div>‚Ä¢ <strong>Training:</strong> Use activity patterns to identify training needs</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function showShiftDetails(shiftId) {
            const shift = shiftHistory.find(s => s.shift_id === shiftId) || 
                         (currentShift && currentShift.shift_id === shiftId ? currentShift : null);
            
            if (!shift) {
                alert('Shift not found');
                return;
            }
            
            const isOpen = shift.status === 'open' || !shift.end_time;
            const startTime = new Date(shift.start_time);
            const endTime = shift.end_time ? new Date(shift.end_time) : new Date();
            
            let cashAnalysis = '';
            if (!isOpen && shift.cash_difference !== null) {
                const cashStatus = shift.cash_difference === 0 ? '‚úÖ Perfect Balance' : 
                                 shift.cash_difference > 0 ? `üí∞ Overage: $${shift.cash_difference.toFixed(2)}` : 
                                 `‚ö†Ô∏è Shortage: $${Math.abs(shift.cash_difference).toFixed(2)}`;
                
                cashAnalysis = `
CASH RECONCILIATION:
Starting Cash: $${shift.starting_cash.toFixed(2)}
Expected Cash: $${shift.expected_cash.toFixed(2)}
Ending Cash: $${shift.ending_cash.toFixed(2)}
Status: ${cashStatus}
                `;
            }
            
            const details = `
DETAILED SHIFT REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Shift ID: ${shift.shift_id}
Status: ${isOpen ? 'üü¢ OPEN' : '‚ö™ CLOSED'}

CASHIER INFORMATION:
Name: ${shift.cashier_name}
Username: ${shift.cashier}
Role: ${shift.role}

TIME INFORMATION:
Start: ${startTime.toLocaleString()}
${!isOpen ? `End: ${endTime.toLocaleString()}` : 'End: Still in progress'}
Duration: ${shift.duration || 'In progress'}

SALES PERFORMANCE:
Total Sales: $${shift.total_sales.toFixed(2)}
Total Transactions: ${shift.total_transactions}
Average Transaction: $${shift.total_transactions > 0 ? (shift.total_sales / shift.total_transactions).toFixed(2) : '0.00'}

PAYMENT BREAKDOWN:
Cash Sales: $${shift.payment_breakdown.Cash.toFixed(2)} (${shift.total_sales > 0 ? ((shift.payment_breakdown.Cash / shift.total_sales) * 100).toFixed(1) : '0'}%)
QR Code Sales: $${shift.payment_breakdown.QRCode.toFixed(2)} (${shift.total_sales > 0 ? ((shift.payment_breakdown.QRCode / shift.total_sales) * 100).toFixed(1) : '0'}%)

${cashAnalysis}
ACTIVITY SUMMARY:
Receipts Processed: ${shift.transactions.length}
Voids Processed: ${shift.voids.length}
${shift.voids.length > 0 ? `Void Rate: ${((shift.voids.length / (shift.transactions.length + shift.voids.length)) * 100).toFixed(1)}%` : ''}
            `;
            
            alert(details);
        }

        function generateFinancialReport(fromDate, toDate) {
            const container = document.getElementById('financialReportContent');
            
            // Filter financial entries based on date range
            let filteredEntries = financialLedger.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredEntries.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No financial entries found for the selected period</p>';
                return;
            }
            
            // Define account types and categories
            const accountTypes = {
                'Cash': { type: 'Asset', category: 'Current Assets', icon: 'üíµ' },
                'QR_Payments': { type: 'Asset', category: 'Current Assets', icon: 'üì±' },
                'Sales_Revenue': { type: 'Revenue', category: 'Operating Revenue', icon: 'üí∞' },
                'Bank_Account': { type: 'Asset', category: 'Current Assets', icon: 'üè¶' },
                'Accounts_Receivable': { type: 'Asset', category: 'Current Assets', icon: 'üìã' },
                'Inventory': { type: 'Asset', category: 'Current Assets', icon: 'üì¶' },
                'Equipment': { type: 'Asset', category: 'Fixed Assets', icon: '‚öôÔ∏è' },
                'Accounts_Payable': { type: 'Liability', category: 'Current Liabilities', icon: 'üìÑ' },
                'Owner_Equity': { type: 'Equity', category: 'Owner\'s Equity', icon: 'üë§' }
            };
            
            // Calculate account balances
            const accountBalances = {};
            const accountTotals = { debits: {}, credits: {} };
            
            filteredEntries.forEach(entry => {
                if (!accountBalances[entry.account]) {
                    accountBalances[entry.account] = 0;
                    accountTotals.debits[entry.account] = 0;
                    accountTotals.credits[entry.account] = 0;
                }
                
                if (entry.type === 'debit') {
                    accountBalances[entry.account] += entry.amount;
                    accountTotals.debits[entry.account] += entry.amount;
                } else {
                    accountBalances[entry.account] -= entry.amount;
                    accountTotals.credits[entry.account] += entry.amount;
                }
            });
            
            // Calculate totals
            const totalDebits = Object.values(accountTotals.debits).reduce((sum, amount) => sum + amount, 0);
            const totalCredits = Object.values(accountTotals.credits).reduce((sum, amount) => sum + amount, 0);
            const isBalanced = Math.abs(totalDebits - totalCredits) < 0.01;
            
            let reportHTML = `
                <div class="mb-4 md:mb-6 p-3 md:p-4 ${isBalanced ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'} rounded-lg border">
                    <h4 class="font-semibold ${isBalanced ? 'text-green-800' : 'text-red-800'} mb-2">
                        ${isBalanced ? '‚úÖ Books are Balanced' : '‚ö†Ô∏è Books are NOT Balanced'}
                    </h4>
                    <div class="grid grid-cols-3 gap-3 md:gap-4">
                        <div class="text-center">
                            <div class="text-lg md:text-2xl font-bold text-blue-600">$${totalDebits.toFixed(2)}</div>
                            <div class="text-xs md:text-sm text-blue-800">Total Debits</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg md:text-2xl font-bold text-green-600">$${totalCredits.toFixed(2)}</div>
                            <div class="text-xs md:text-sm text-green-800">Total Credits</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg md:text-2xl font-bold ${isBalanced ? 'text-green-600' : 'text-red-600'}">$${Math.abs(totalDebits - totalCredits).toFixed(2)}</div>
                            <div class="text-xs md:text-sm ${isBalanced ? 'text-green-800' : 'text-red-800'}">Difference</div>
                        </div>
                    </div>
                </div>
                
                <!-- Payment Method Analysis -->
                <div class="mb-4 md:mb-6 bg-white p-3 md:p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üí≥ Payment Method Analysis</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                        <div class="bg-green-50 p-3 md:p-4 rounded-lg border border-green-200">
                            <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                üíµ Cash Transactions
                            </h5>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>Total Received:</span>
                                    <span class="font-bold text-green-600">$${(accountTotals.debits['Cash'] || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Total Refunded:</span>
                                    <span class="font-bold text-red-600">$${(accountTotals.credits['Cash'] || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2 text-sm">
                                    <span class="font-medium">Net Cash:</span>
                                    <span class="font-bold text-green-800">$${(accountBalances['Cash'] || 0).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 p-3 md:p-4 rounded-lg border border-blue-200">
                            <h5 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                üì± QR Code Transactions
                            </h5>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span>Total Received:</span>
                                    <span class="font-bold text-blue-600">$${(accountTotals.debits['QR_Payments'] || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span>Total Refunded:</span>
                                    <span class="font-bold text-red-600">$${(accountTotals.credits['QR_Payments'] || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between border-t pt-2 text-sm">
                                    <span class="font-medium">Net QR:</span>
                                    <span class="font-bold text-blue-800">$${(accountBalances['QR_Payments'] || 0).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Method Comparison -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <h6 class="font-medium text-gray-800 mb-2">Payment Method Comparison:</h6>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-lg font-bold text-green-600">$${((accountTotals.debits['Cash'] || 0) + (accountTotals.debits['QR_Payments'] || 0)).toFixed(2)}</div>
                                <div class="text-xs text-gray-600">Total Payments</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-gray-600">${(((accountTotals.debits['Cash'] || 0) / ((accountTotals.debits['Cash'] || 0) + (accountTotals.debits['QR_Payments'] || 0)) * 100) || 0).toFixed(1)}%</div>
                                <div class="text-xs text-gray-600">Cash %</div>
                            </div>
                            <div>
                                <div class="text-lg font-bold text-gray-600">${(((accountTotals.debits['QR_Payments'] || 0) / ((accountTotals.debits['Cash'] || 0) + (accountTotals.debits['QR_Payments'] || 0)) * 100) || 0).toFixed(1)}%</div>
                                <div class="text-xs text-gray-600">QR %</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                    <h5 class="font-semibold text-blue-800 mb-2">üìö Accounting Principles Applied:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Sales:</strong> Debit Cash/QR Payments, Credit Sales Revenue</div>
                        <div>‚Ä¢ <strong>Voids:</strong> Credit Cash/QR Payments, Debit Sales Revenue (reversal)</div>
                        <div>‚Ä¢ <strong>Account Types:</strong> Assets (Cash, QR), Revenue (Sales), organized by payment method</div>
                        <div>‚Ä¢ <strong>Double Entry:</strong> Every transaction has equal debits and credits</div>
                        <div>‚Ä¢ <strong>Real-time Tracking:</strong> All entries are recorded immediately</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function generateActivityReport(fromDate, toDate) {
            const container = document.getElementById('activityReportContent');
            
            // Filter activity log based on date range
            let filteredActivities = activityLog.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                return entryDate >= fromDate && entryDate <= toDate;
            });
            
            if (filteredActivities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No activity found for the selected period</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            filteredActivities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Calculate summary statistics
            const totalActivities = filteredActivities.length;
            const uniqueUsers = [...new Set(filteredActivities.map(a => a.user))].length;
            const activityTypes = {};
            const levelCounts = { info: 0, warning: 0, error: 0, critical: 0 };
            
            filteredActivities.forEach(activity => {
                activityTypes[activity.action] = (activityTypes[activity.action] || 0) + 1;
                levelCounts[activity.level] = (levelCounts[activity.level] || 0) + 1;
            });
            
            // Get top activities
            const topActivities = Object.entries(activityTypes)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            let reportHTML = `
                <!-- Activity Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
                    <div class="bg-blue-50 p-3 md:p-4 rounded-lg text-center border border-blue-200">
                        <div class="text-lg md:text-2xl font-bold text-blue-600">${totalActivities}</div>
                        <div class="text-xs md:text-sm text-blue-800">Total Activities</div>
                    </div>
                    <div class="bg-green-50 p-3 md:p-4 rounded-lg text-center border border-green-200">
                        <div class="text-lg md:text-2xl font-bold text-green-600">${uniqueUsers}</div>
                        <div class="text-xs md:text-sm text-green-800">Active Users</div>
                    </div>
                    <div class="bg-yellow-50 p-3 md:p-4 rounded-lg text-center border border-yellow-200">
                        <div class="text-lg md:text-2xl font-bold text-yellow-600">${levelCounts.warning + levelCounts.error}</div>
                        <div class="text-xs md:text-sm text-yellow-800">Warnings/Errors</div>
                    </div>
                    <div class="bg-red-50 p-3 md:p-4 rounded-lg text-center border border-red-200">
                        <div class="text-lg md:text-2xl font-bold text-red-600">${levelCounts.critical}</div>
                        <div class="text-xs md:text-sm text-red-800">Critical Events</div>
                    </div>
                </div>
                
                <!-- Activity Level Breakdown -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üìä Activity Levels</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ÑπÔ∏è</div>
                            <div class="font-bold text-blue-600">${levelCounts.info}</div>
                            <div class="text-xs text-gray-600">Info</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ö†Ô∏è</div>
                            <div class="font-bold text-yellow-600">${levelCounts.warning}</div>
                            <div class="text-xs text-gray-600">Warning</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">‚ùå</div>
                            <div class="font-bold text-red-600">${levelCounts.error}</div>
                            <div class="text-xs text-gray-600">Error</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl mb-1">üö®</div>
                            <div class="font-bold text-red-800">${levelCounts.critical}</div>
                            <div class="text-xs text-gray-600">Critical</div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Activities -->
                <div class="mb-6 bg-white p-4 rounded-lg border">
                    <h4 class="font-semibold mb-4">üî• Most Common Activities</h4>
                    <div class="space-y-2">
            `;
            
            topActivities.forEach(([activity, count], index) => {
                const percentage = ((count / totalActivities) * 100).toFixed(1);
                reportHTML += `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-gray-600">#${index + 1}</span>
                            <span class="text-sm">${activity.replace(/_/g, ' ').toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${count}</div>
                            <div class="text-xs text-gray-500">${percentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            reportHTML += `
                    </div>
                </div>
                
                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg border overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b flex justify-between items-center">
                        <h4 class="font-semibold">üìù Recent Activity Log</h4>
                        <div class="text-sm text-gray-600">Showing last 50 entries</div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 md:px-4 py-2 text-left">Time</th>
                                    <th class="px-2 md:px-4 py-2 text-left">User</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Action</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Level</th>
                                    <th class="px-2 md:px-4 py-2 text-left">Details</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Show only last 50 entries for performance
            const recentActivities = filteredActivities.slice(0, 50);
            
            recentActivities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const timeAgo = getTimeAgo(date);
                
                const levelColors = {
                    'info': 'text-blue-600 bg-blue-50',
                    'warning': 'text-yellow-600 bg-yellow-50',
                    'error': 'text-red-600 bg-red-50',
                    'critical': 'text-red-800 bg-red-100'
                };
                
                const levelEmojis = {
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                
                // Format details for display
                let detailsText = '';
                if (activity.details && Object.keys(activity.details).length > 0) {
                    const keyDetails = [];
                    if (activity.details.receipt_number) keyDetails.push(`Receipt: ${activity.details.receipt_number}`);
                    if (activity.details.total) keyDetails.push(`$${activity.details.total}`);
                    if (activity.details.shift_id) keyDetails.push(`Shift: ${activity.details.shift_id}`);
                    if (activity.details.username) keyDetails.push(`User: ${activity.details.username}`);
                    if (activity.details.success !== undefined) keyDetails.push(activity.details.success ? 'Success' : 'Failed');
                    
                    detailsText = keyDetails.join(', ') || 'See console for full details';
                }
                
                reportHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs font-medium">${date.toLocaleTimeString()}</div>
                            <div class="text-xs text-gray-500">${timeAgo}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.user}</div>
                            <div class="text-xs text-gray-500">${activity.user_role}</div>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="font-medium">${activity.action.replace(/_/g, ' ')}</div>
                            ${activity.shift_id ? `<div class="text-xs text-gray-500">${activity.shift_id}</div>` : ''}
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${levelColors[activity.level]}">
                                ${levelEmojis[activity.level]} ${activity.level}
                            </span>
                        </td>
                        <td class="px-2 md:px-4 py-2">
                            <div class="text-xs text-gray-600 max-w-xs truncate" title="${detailsText}">
                                ${detailsText}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            reportHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Activity Log Tips -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <h5 class="font-semibold text-blue-800 mb-2">üí° Activity Log Usage Tips:</h5>
                    <div class="text-sm text-blue-700 space-y-1">
                        <div>‚Ä¢ <strong>Security Monitoring:</strong> Watch for failed login attempts and critical events</div>
                        <div>‚Ä¢ <strong>User Behavior:</strong> Track which users perform which actions most frequently</div>
                        <div>‚Ä¢ <strong>System Health:</strong> Monitor error and warning levels for system issues</div>
                        <div>‚Ä¢ <strong>Audit Trail:</strong> Complete record of all system activities for compliance</div>
                        <div>‚Ä¢ <strong>Performance:</strong> Identify peak activity times and user patterns</div>
                        <div>‚Ä¢ <strong>Training:</strong> Use activity patterns to identify training needs</div>
                    </div>
                </div>
            `;
            
            container.innerHTML = reportHTML;
        }

        function exportReportToExcel() {
            if (!currentReportData) {
                alert('Please generate a report first');
                return;
            }
            
            let data = [];
            let filename = '';
            
            if (currentReportType === 'sales') {
                // Export sales summary
                data = currentReportData.map(t => ({
                    'Receipt Number': t.receipt_number,
                    'Date': new Date(t.timestamp).toLocaleDateString(),
                    'Time': new Date(t.timestamp).toLocaleTimeString(),
                    'Cashier': t.cashier,
                    'Payment Type': t.payment_type,
                    'Subtotal': t.subtotal.toFixed(2),
                    'Discount %': t.discount_percent,
                    'Discount Amount': t.discount_amount.toFixed(2),
                    'Total': t.total.toFixed(2)
                }));
                filename = 'sales_report';
            } else if (currentReportType === 'items') {
                // Export item performance
                const itemSales = {};
                currentReportData.forEach(t => {
                    t.items.forEach(item => {
                        const key = item.name;
                        if (!itemSales[key]) {
                            itemSales[key] = { name: item.name, quantity: 0, revenue: 0 };
                        }
                        itemSales[key].quantity += item.quantity;
                        itemSales[key].revenue += item.price * item.quantity;
                    });
                });
                
                data = Object.values(itemSales).map(item => ({
                    'Item Name': item.name,
                    'Quantity Sold': item.quantity,
                    'Revenue': item.revenue.toFixed(2),
                    'Average Price': (item.revenue / item.quantity).toFixed(2)
                }));
                filename = 'item_performance_report';
            }
            
            // Create Excel file
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${filename}_${today}.xlsx`);
        }

        function printReport() {
            const reportContent = document.querySelector('.report-tab:not(.hidden)').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Sales Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #f2f2f2; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .font-bold { font-weight: bold; }
                            .bg-yellow-50 { background-color: #fffbeb; }
                            .bg-red-50 { background-color: #fef2f2; }
                            .bg-green-50 { background-color: #f0fdf4; }
                        </style>
                    </head>
                    <body>
                        <h1>Sales Report - ${new Date().toLocaleDateString()}</h1>
                        ${reportContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            printWindow.close();
        }

        // Settings and other functions (simplified for mobile)
        function showSettings() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            // Populate current settings
            document.getElementById('settingsBusinessName').value = systemSettings.businessName;
            document.getElementById('settingsBusinessAddress').value = systemSettings.businessAddress;
            document.getElementById('settingsWifiName').value = systemSettings.wifiName;
            document.getElementById('settingsWifiPassword').value = systemSettings.wifiPassword;
            document.getElementById('settingsExchangeRate').value = systemSettings.exchangeRate;
            document.getElementById('settingsTaxRate').value = systemSettings.taxRate;
            
            // Show users list
            displayUsersList();
            
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function showVoidReceipt() {
            if (transactionHistory.length === 0) {
                alert('No transactions available to void');
                return;
            }
            
            // Show recent transactions for voiding
            displayVoidableTransactions();
            document.getElementById('voidModal').classList.remove('hidden');
        }

        function toggleShift() {
            if (currentShift) {
                // Close current shift
                if (confirm('Close current shift? This will generate a shift summary report.')) {
                    closeCurrentShift();
                }
            } else {
                // Start new shift
                startNewShift();
            }
        }

        function startNewShift() {
            const startingCash = prompt('Enter starting cash amount for this shift:', '0.00');
            if (startingCash === null) return;
            
            const cashAmount = parseFloat(startingCash) || 0;
            
            // Reset receipt counter to 001 for new shift
            receiptCounter = 1;
            
            currentShift = {
                shift_id: `S${String(shiftHistory.length + 1).padStart(3, '0')}`,
                cashier: currentUser.username,
                cashier_name: currentUser.fullName,
                role: currentUser.role,
                start_time: new Date().toISOString(),
                starting_cash: cashAmount,
                ending_cash: null,
                cash_difference: null,
                transactions: [],
                voids: [],
                total_sales: 0,
                total_transactions: 0,
                payment_breakdown: { Cash: 0, QRCode: 0 },
                status: 'open',
                receipt_range: { start: 1, end: 100 } // Track receipt range for this shift
            };
            
            // Record financial entry for starting cash
            if (cashAmount > 0) {
                recordFinancialEntry({
                    type: 'debit',
                    account: 'Cash',
                    amount: cashAmount,
                    description: `Shift Start - ${currentShift.shift_id}`,
                    reference: currentShift.shift_id,
                    timestamp: currentShift.start_time
                });
            }
            
            updateShiftStatus();
            updateReceiptDisplays(); // Update receipt display to show 001
            saveToDatabase('shift_started', currentShift);
            
            // Log shift start
            logShiftActivity('started', currentShift);
            
            alert(`Shift started successfully!\nShift ID: ${currentShift.shift_id}\nStarting Cash: $${cashAmount.toFixed(2)}\nReceipt Range: #001 - #100`);
        }

        function closeCurrentShift() {
            const endingCash = prompt('Enter ending cash amount for this shift:', currentShift.starting_cash.toFixed(2));
            if (endingCash === null) return;
            
            const cashAmount = parseFloat(endingCash) || 0;
            const expectedCash = currentShift.starting_cash + currentShift.payment_breakdown.Cash;
            const cashDifference = cashAmount - expectedCash;
            
            // Complete shift data
            currentShift.end_time = new Date().toISOString();
            currentShift.ending_cash = cashAmount;
            currentShift.expected_cash = expectedCash;
            currentShift.cash_difference = cashDifference;
            currentShift.status = 'closed';
            
            // Calculate shift duration
            const startTime = new Date(currentShift.start_time);
            const endTime = new Date(currentShift.end_time);
            const durationMs = endTime - startTime;
            const hours = Math.floor(durationMs / (1000 * 60 * 60));
            const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
            currentShift.duration = `${hours}h ${minutes}m`;
            
            // Add to shift history
            shiftHistory.push({ ...currentShift });
            
            // Record ending cash entry if different from expected
            if (cashDifference !== 0) {
                recordFinancialEntry({
                    type: cashDifference > 0 ? 'debit' : 'credit',
                    account: 'Cash',
                    amount: Math.abs(cashDifference),
                    description: `Cash ${cashDifference > 0 ? 'Overage' : 'Shortage'} - ${currentShift.shift_id}`,
                    reference: currentShift.shift_id,
                    timestamp: currentShift.end_time
                });
            }
            
            saveToDatabase('shift_closed', currentShift);
            
            // Log shift close
            logShiftActivity('closed', currentShift);
            
            // Show shift summary
            showShiftSummary(currentShift);
            
            // Reset current shift and prepare for next shift
            currentShift = null;
            // Keep receipt counter as is - will be reset when new shift starts
            updateShiftStatus();
        }

        function showShiftSummary(shift) {
            const cashStatus = shift.cash_difference === 0 ? '‚úÖ Balanced' : 
                             shift.cash_difference > 0 ? `üí∞ Overage: $${shift.cash_difference.toFixed(2)}` : 
                             `‚ö†Ô∏è Shortage: $${Math.abs(shift.cash_difference).toFixed(2)}`;
            
            const receiptRange = shift.receipt_range ? 
                `Receipt Range: #${String(shift.receipt_range.start).padStart(3, '0')} - #${String(Math.min(shift.receipt_range.start + shift.total_transactions - 1, 100)).padStart(3, '0')}` :
                'Receipt Range: N/A';
            
            const summary = `
SHIFT SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Shift ID: ${shift.shift_id}
Cashier: ${shift.cashier_name} (${shift.role})
Duration: ${shift.duration}
${receiptRange}

FINANCIAL SUMMARY:
Starting Cash: $${shift.starting_cash.toFixed(2)}
Ending Cash: $${shift.ending_cash.toFixed(2)}
Expected Cash: $${shift.expected_cash.toFixed(2)}
Cash Status: ${cashStatus}

SALES SUMMARY:
Total Sales: $${shift.total_sales.toFixed(2)}
Transactions: ${shift.total_transactions}
Cash Sales: $${shift.payment_breakdown.Cash.toFixed(2)}
QR Sales: $${shift.payment_breakdown.QRCode.toFixed(2)}
Voids: ${shift.voids.length}

Average Transaction: $${shift.total_transactions > 0 ? (shift.total_sales / shift.total_transactions).toFixed(2) : '0.00'}
            `;
            
            alert(summary);
        }

        function updateShiftStatus() {
            const statusElements = ['shiftStatus', 'mobileShiftStatus'];
            const btnElements = ['shiftBtn', 'mobileShiftBtn'];
            
            statusElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (currentShift) {
                        element.textContent = `Shift Open - ${currentShift.shift_id}`;
                        element.className = 'bg-green-100 text-green-800 px-2 py-1 rounded-full';
                    } else {
                        element.textContent = 'Shift Closed';
                        element.className = 'bg-red-100 text-red-800 px-2 py-1 rounded-full';
                    }
                }
            });
            
            btnElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (currentShift) {
                        element.innerHTML = id === 'shiftBtn' ? 'üïê' : 'üïê Close Shift';
                        element.className = element.className.replace('bg-green-600', 'bg-red-600').replace('hover:bg-green-700', 'hover:bg-red-700');
                    } else {
                        element.innerHTML = id === 'shiftBtn' ? 'üïê' : 'üïê Start Shift';
                        element.className = element.className.replace('bg-red-600', 'bg-green-600').replace('hover:bg-red-700', 'hover:bg-green-700');
                    }
                }
            });
        }

        // Utility Functions
        function setupRolePermissions(role) {
            // Hide all admin functions by default
            const adminElements = ['addCategoryBtn', 'addItemBtn', 'settingsBtn', 'mobileSettingsBtn'];
            adminElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = role === 'admin' ? 'block' : 'none';
                }
            });
        }

        function hasPermission(requiredRole) {
            if (!currentUser) return false;
            return requiredRole === 'admin' ? currentUser.role === 'admin' : true;
        }

        function updateReceiptDisplays() {
            const element = document.getElementById('receiptNumber');
            const progressElement = document.getElementById('receiptProgress');
            
            if (element) {
                element.textContent = `Receipt #${String(receiptCounter).padStart(3, '0')}`;
            }
            
            if (progressElement && currentShift) {
                const currentReceipt = receiptCounter - 1; // Subtract 1 because counter is for next receipt
                progressElement.textContent = `${currentReceipt}/100 receipts`;
                progressElement.style.display = 'block';
                
                // Change color based on progress
                if (currentReceipt >= 90) {
                    progressElement.className = 'text-xs text-red-500 mt-1';
                } else if (currentReceipt >= 75) {
                    progressElement.className = 'text-xs text-orange-500 mt-1';
                } else {
                    progressElement.className = 'text-xs text-gray-500 mt-1';
                }
            } else if (progressElement) {
                progressElement.style.display = 'none';
            }
        }

        function updateReceiptNumber() {
            receiptCounter++;
            updateReceiptDisplays();
        }

        function startRealTimeClock() {
            realTimeInterval = setInterval(() => {
                const now = new Date();
                const dateElement = document.getElementById('realTimeDate');
                const timeElement = document.getElementById('realTimeTime');
                
                if (dateElement) dateElement.textContent = now.toLocaleDateString();
                if (timeElement) timeElement.textContent = now.toLocaleTimeString();
            }, 1000);
        }

        function stopRealTimeClock() {
            if (realTimeInterval) {
                clearInterval(realTimeInterval);
                realTimeInterval = null;
            }
        }

        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.classList.add('hidden');
                eyeOffIcon.classList.remove('hidden');
            } else {
                passwordInput.type = 'password';
                eyeIcon.classList.remove('hidden');
                eyeOffIcon.classList.add('hidden');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function initializeSystem() {
            updateReceiptDisplays();
            document.getElementById('navExchangeRate').textContent = systemSettings.exchangeRate.toLocaleString();
            updateCartItemCount();
        }

        function quickEditExchangeRate() {
            const currentRate = systemSettings.exchangeRate;
            const newRate = prompt(`Enter new exchange rate (USD to KHR):\nCurrent rate: 1 USD = ·üõ${currentRate.toLocaleString()}`, currentRate);
            
            if (newRate !== null && !isNaN(newRate) && parseFloat(newRate) > 0) {
                systemSettings.exchangeRate = parseFloat(newRate);
                
                // Update display
                document.getElementById('navExchangeRate').textContent = systemSettings.exchangeRate.toLocaleString();
                
                // Update current order totals
                updateTotal();
                updateMobileTotal();
                
                // Save to database
                saveToDatabase('exchange_rate_change', { 
                    old_rate: currentRate, 
                    new_rate: systemSettings.exchangeRate, 
                    changed_by: currentUser.username, 
                    timestamp: new Date().toISOString() 
                });
                
                alert(`Exchange rate updated successfully!\nNew rate: 1 USD = ·üõ${systemSettings.exchangeRate.toLocaleString()}`);
            } else if (newRate !== null) {
                alert('Please enter a valid positive number for the exchange rate.');
            }
        }

        function logout() {
            if (currentShift) {
                if (!confirm('You have an open shift. Are you sure you want to logout? This will not close your shift.')) {
                    return;
                }
            }
            
            // Log logout before clearing currentUser
            const logoutUser = currentUser ? currentUser.username : 'unknown';
            const logoutReason = currentShift ? 'manual_with_open_shift' : 'manual';
            
            logUserLogout(logoutUser, logoutReason);
            
            stopRealTimeClock();
            currentUser = null;
            currentOrder = [];
            
            // Close mobile menus
            if (isMobileMenuOpen) toggleMobileMenu();
            if (isMobileCartOpen) toggleMobileCart();
            
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('posInterface').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Settings Functions
        let selectedTransactionForVoid = null;
        
        function showSettingsTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById(tabName + 'Settings').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('[id$="SettingsTab"]').forEach(btn => {
                btn.className = 'flex-shrink-0 py-2 px-3 md:px-4 rounded-md text-gray-600 hover:text-gray-800 text-sm';
            });
            
            document.getElementById(tabName + 'SettingsTab').className = 'flex-shrink-0 py-2 px-3 md:px-4 rounded-md bg-white text-blue-600 font-medium text-sm';
            
            // Update system info if on system tab
            if (tabName === 'system') {
                updateSystemInfo();
            }
        }
        
        function updateSystemInfo() {
            const totalRevenue = transactionHistory.reduce((sum, t) => sum + (t.voided ? 0 : t.total), 0);
            const activeUsers = systemUsers.filter(u => u.active).length;
            
            document.getElementById('totalTransactionsCount').textContent = transactionHistory.filter(t => !t.voided).length;
            document.getElementById('totalRevenueAmount').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('activeUsersCount').textContent = activeUsers;
            document.getElementById('menuItemsCount').textContent = menuItems.length;
        }
        
        function displayUsersList() {
            const container = document.getElementById('usersList');
            container.innerHTML = '';
            
            systemUsers.forEach(user => {
                const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusText = user.active ? 'Active' : 'Disabled';
                const toggleText = user.active ? 'Disable' : 'Enable';
                const toggleClass = user.active ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
                
                container.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-semibold text-gray-800">${user.fullName}</h5>
                                <p class="text-sm text-gray-600">@${user.username}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">${user.role}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${user.id !== currentUser.id ? `
                                    <button onclick="toggleUserStatus(${user.id})" class="px-3 py-1 rounded text-white text-sm ${toggleClass} transition touch-btn">${toggleText}</button>
                                    <button onclick="deleteUser(${user.id})" class="px-3 py-1 rounded bg-red-500 text-white text-sm hover:bg-red-600 transition touch-btn">Delete</button>
                                ` : '<span class="text-xs text-gray-500 px-3 py-1">Current User</span>'}
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        function showAddUser() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }
        
        function toggleUserStatus(userId) {
            const user = systemUsers.find(u => u.id === userId);
            if (user && user.id !== currentUser.id) {
                user.active = !user.active;
                displayUsersList();
                saveToDatabase('user_status_change', { user_id: userId, active: user.active, changed_by: currentUser.username });
                alert(`User ${user.active ? 'enabled' : 'disabled'} successfully!`);
            }
        }
        
        function deleteUser(userId) {
            const user = systemUsers.find(u => u.id === userId);
            if (user && user.id !== currentUser.id) {
                if (confirm(`Are you sure you want to delete user "${user.fullName}"? This action cannot be undone.`)) {
                    const userIndex = systemUsers.findIndex(u => u.id === userId);
                    systemUsers.splice(userIndex, 1);
                    displayUsersList();
                    saveToDatabase('user_deleted', { user_id: userId, deleted_by: currentUser.username });
                    alert('User deleted successfully!');
                }
            }
        }
        
        function clearAllTransactions() {
            if (confirm('Are you sure you want to clear ALL transaction history? This action cannot be undone.')) {
                if (confirm('This will permanently delete all sales data, receipts, and financial records. Type "CONFIRM" to proceed.')) {
                    const confirmation = prompt('Type "CONFIRM" to permanently delete all transaction data:');
                    if (confirmation === 'CONFIRM') {
                        transactionHistory = [];
                        voidHistory = [];
                        financialLedger = [];
                        receiptCounter = 1;
                        updateReceiptDisplays();
                        updateSystemInfo();
                        saveToDatabase('system_reset_transactions', { cleared_by: currentUser.username, timestamp: new Date().toISOString() });
                        alert('All transaction data has been cleared successfully!');
                    }
                }
            }
        }
        
        function resetSystem() {
            if (confirm('Are you sure you want to reset the entire system to default settings? This will delete ALL data.')) {
                if (confirm('This will delete all users (except admin), transactions, settings, and menu items. This cannot be undone.')) {
                    const confirmation = prompt('Type "RESET SYSTEM" to confirm complete system reset:');
                    if (confirmation === 'RESET SYSTEM') {
                        // Reset all data to defaults
                        systemUsers = [
                            { id: 1, username: 'admin', password: 'admin123', role: 'admin', fullName: 'System Administrator', active: true }
                        ];
                        transactionHistory = [];
                        voidHistory = [];
                        financialLedger = [];
                        receiptCounter = 1;
                        systemSettings = {
                            businessName: 'Cafe POS System',
                            businessAddress: '123 Main Street, City, Country',
                            wifiName: 'Cafe_WiFi',
                            wifiPassword: 'cafe123456',
                            exchangeRate: 4100,
                            taxRate: 0
                        };
                        
                        // Reset menu to default
                        menuItems = [
                            { id: 1, name: 'Espresso', category: 'Coffee', price: 3.50, image: '' },
                            { id: 2, name: 'Cappuccino', category: 'Coffee', price: 4.25, image: '' },
                            { id: 3, name: 'Latte', category: 'Coffee', price: 4.75, image: '' },
                            { id: 4, name: 'Green Tea', category: 'Tea', price: 2.50, image: '' },
                            { id: 5, name: 'Earl Grey', category: 'Tea', price: 2.75, image: '' },
                            { id: 6, name: 'Croissant', category: 'Pastries', price: 3.00, image: '' },
                            { id: 7, name: 'Muffin', category: 'Pastries', price: 2.75, image: '' },
                            { id: 8, name: 'Orange Juice', category: 'Beverages', price: 3.25, image: '' }
                        ];
                        
                        loadMenuData();
                        updateSystemInfo();
                        displayUsersList();
                        saveToDatabase('system_complete_reset', { reset_by: currentUser.username, timestamp: new Date().toISOString() });
                        alert('System has been completely reset to default settings!');
                    }
                }
            }
        }
        
        // Void Functions
        function displayVoidableTransactions() {
            const container = document.getElementById('voidableTransactionsList');
            container.innerHTML = '';
            
            // Managers can void any transaction, staff can only void from current shift
            let recentTransactions;
            if (currentUser.role === 'admin') {
                // Admins can void any transaction from last 30 days
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                recentTransactions = transactionHistory.filter(t => 
                    new Date(t.timestamp) > thirtyDaysAgo && !t.voided
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            } else {
                // Staff can only void from current shift or last 7 days if no shift is open
                if (currentShift) {
                    recentTransactions = transactionHistory.filter(t => 
                        currentShift.transactions.includes(t.receipt_number) && !t.voided
                    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                } else {
                    const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    recentTransactions = transactionHistory.filter(t => 
                        new Date(t.timestamp) > sevenDaysAgo && !t.voided
                    ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
            }
            
            if (recentTransactions.length === 0) {
                const timeframe = currentUser.role === 'admin' ? 'last 30 days' : 
                                 currentShift ? 'current shift' : 'last 7 days';
                container.innerHTML = `<p class="text-gray-500 text-center py-4">No transactions available for voiding (showing ${timeframe})</p>`;
                return;
            }
            
            recentTransactions.forEach(transaction => {
                const date = new Date(transaction.timestamp);
                const timeAgo = getTimeAgo(date);
                
                container.innerHTML += `
                    <div class="bg-white p-3 rounded-lg border hover:bg-gray-50 cursor-pointer transition" onclick="selectTransactionForVoid('${transaction.receipt_number}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-gray-800">Receipt #${transaction.receipt_number}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${transaction.payment_type === 'Cash' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">${transaction.payment_type}</span>
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    ${date.toLocaleDateString()} ${date.toLocaleTimeString()} ‚Ä¢ ${timeAgo}
                                </div>
                                <div class="text-xs text-gray-500">
                                    ${transaction.items.length} item(s) ‚Ä¢ Cashier: ${transaction.cashier}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-lg text-red-600">$${transaction.total.toFixed(2)}</div>
                                <div class="text-xs text-gray-500">Click to void</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        function selectTransactionForVoid(receiptNumber) {
            selectedTransactionForVoid = transactionHistory.find(t => t.receipt_number === receiptNumber);
            
            if (selectedTransactionForVoid) {
                // Hide transaction list and show void reason form
                document.getElementById('voidableTransactionsList').style.display = 'none';
                document.getElementById('voidReasonForm').classList.remove('hidden');
                
                // Clear previous selections
                document.querySelectorAll('input[name="voidReason"]').forEach(radio => radio.checked = false);
                document.getElementById('voidNotes').value = '';
            }
        }
        
        function cancelVoid() {
            selectedTransactionForVoid = null;
            document.getElementById('voidableTransactionsList').style.display = 'block';
            document.getElementById('voidReasonForm').classList.add('hidden');
        }
        
        function confirmVoidTransaction() {
            if (!selectedTransactionForVoid) {
                alert('No transaction selected for voiding');
                return;
            }
            
            const selectedReason = document.querySelector('input[name="voidReason"]:checked');
            if (!selectedReason) {
                alert('Please select a reason for voiding this transaction');
                return;
            }
            
            const voidReason = selectedReason.value;
            const voidNotes = document.getElementById('voidNotes').value.trim();
            
            if (confirm(`Are you sure you want to void Receipt #${selectedTransactionForVoid.receipt_number} for $${selectedTransactionForVoid.total.toFixed(2)}?`)) {
                // Mark transaction as voided
                selectedTransactionForVoid.voided = true;
                selectedTransactionForVoid.void_timestamp = new Date().toISOString();
                selectedTransactionForVoid.void_reason = voidReason;
                selectedTransactionForVoid.void_notes = voidNotes;
                selectedTransactionForVoid.voided_by = currentUser.username;
                
                // Create void record
                const voidRecord = {
                    void_id: `V${String(voidHistory.length + 1).padStart(3, '0')}`,
                    original_receipt: selectedTransactionForVoid.receipt_number,
                    void_amount: selectedTransactionForVoid.total,
                    void_reason: voidReason,
                    void_notes: voidNotes,
                    void_timestamp: new Date().toISOString(),
                    voided_by: currentUser.username,
                    original_transaction: { ...selectedTransactionForVoid }
                };
                
                voidHistory.push(voidRecord);
                
                // Log void transaction
                logVoidTransaction(voidRecord);
                
                // Update current shift data if shift is open
                if (currentShift) {
                    currentShift.voids.push(voidRecord.void_id);
                    currentShift.total_sales -= selectedTransactionForVoid.total;
                    currentShift.total_transactions -= 1;
                    currentShift.payment_breakdown[selectedTransactionForVoid.payment_type] -= selectedTransactionForVoid.total;
                }
                
                // Reverse financial entries
                recordFinancialEntry({
                    type: 'credit',
                    account: selectedTransactionForVoid.payment_type === 'Cash' ? 'Cash' : 'QR_Payments',
                    amount: selectedTransactionForVoid.total,
                    description: `Void - Receipt #${selectedTransactionForVoid.receipt_number}`,
                    reference: voidRecord.void_id,
                    timestamp: voidRecord.void_timestamp
                });
                
                recordFinancialEntry({
                    type: 'debit',
                    account: 'Sales_Revenue',
                    amount: selectedTransactionForVoid.total,
                    description: `Void - Receipt #${selectedTransactionForVoid.receipt_number}`,
                    reference: voidRecord.void_id,
                    timestamp: voidRecord.void_timestamp
                });
                
                // Save to database
                saveToDatabase('transaction_voided', voidRecord);
                
                alert(`Transaction voided successfully!\nVoid ID: ${voidRecord.void_id}\nAmount: $${selectedTransactionForVoid.total.toFixed(2)}`);
                
                // Close modal and reset
                closeModal('voidModal');
                selectedTransactionForVoid = null;
            }
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes}m ago`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours}h ago`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays}d ago`;
        }
        
        // Form Handlers
        $('#businessSettingsForm').on('submit', function(e) {
            e.preventDefault();
            
            const oldSettings = { ...systemSettings };
            
            systemSettings.businessName = $('#settingsBusinessName').val().trim();
            systemSettings.businessAddress = $('#settingsBusinessAddress').val().trim();
            systemSettings.wifiName = $('#settingsWifiName').val().trim();
            systemSettings.wifiPassword = $('#settingsWifiPassword').val().trim();
            systemSettings.exchangeRate = parseFloat($('#settingsExchangeRate').val());
            systemSettings.taxRate = parseFloat($('#settingsTaxRate').val()) || 0;
            
            // Update exchange rate display
            document.getElementById('navExchangeRate').textContent = systemSettings.exchangeRate.toLocaleString();
            
            // Update current order totals
            updateTotal();
            updateMobileTotal();
            
            // Log settings changes
            Object.keys(systemSettings).forEach(key => {
                if (oldSettings[key] !== systemSettings[key]) {
                    logSettingsChange(key, oldSettings[key], systemSettings[key]);
                }
            });
            
            // Save to database
            saveToDatabase('settings_updated', { 
                old_settings: oldSettings, 
                new_settings: systemSettings, 
                updated_by: currentUser.username, 
                timestamp: new Date().toISOString() 
            });
            
            alert('Business settings saved successfully!');
        });
        
        $('#addUserForm').on('submit', function(e) {
            e.preventDefault();
            
            const fullName = $('#newUserFullName').val().trim();
            const username = $('#newUserUsername').val().trim();
            const password = $('#newUserPassword').val();
            const role = $('#newUserRole').val();
            
            // Check if username already exists
            if (systemUsers.find(u => u.username === username)) {
                alert('Username already exists. Please choose a different username.');
                return;
            }
            
            // Create new user
            const newUser = {
                id: Math.max(...systemUsers.map(u => u.id)) + 1,
                username: username,
                password: password,
                role: role,
                fullName: fullName,
                active: true
            };
            
            systemUsers.push(newUser);
            displayUsersList();
            
            // Log user creation
            logActivity('user_created', {
                new_user_id: newUser.id,
                new_username: newUser.username,
                new_user_role: newUser.role,
                new_user_fullname: newUser.fullName,
                created_by: currentUser.username
            }, 'info');
            
            // Save to database
            saveToDatabase('user_created', { 
                user: newUser, 
                created_by: currentUser.username, 
                timestamp: new Date().toISOString() 
            });
            
            alert(`User "${fullName}" created successfully!`);
            closeModal('addUserModal');
            
            // Reset form
            $('#addUserForm')[0].reset();
        });

        // Backup and Restore System
        function generateBackupReport() {
            const container = document.getElementById('backupReportContent');
            
            // Update backup history display
            updateBackupHistoryDisplay();
            
            // Update auto backup settings display
            updateAutoBackupDisplay();
            
            // Log backup report access
            logActivity('backup_report_accessed', {
                backup_count: backupHistory.length,
                auto_backup_enabled: autoBackupSettings.frequency !== 'disabled',
                last_backup: autoBackupSettings.lastBackup
            }, 'info');
            
            // The backup report content is already populated in the HTML
            // No additional generation needed as it's interactive
        }

        function createFullBackup() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                type: 'full',
                created_by: currentUser.username,
                data: {
                    systemUsers: systemUsers,
                    systemSettings: systemSettings,
                    menuItems: menuItems,
                    categories: categories,
                    transactionHistory: transactionHistory,
                    voidHistory: voidHistory,
                    shiftHistory: shiftHistory,
                    financialLedger: financialLedger,
                    activityLog: activityLog.slice(-1000), // Last 1000 entries
                    backupHistory: backupHistory,
                    autoBackupSettings: autoBackupSettings
                }
            };
            
            const backupId = `FULL_${Date.now()}`;
            const filename = `cafe_pos_full_backup_${new Date().toISOString().split('T')[0]}_${backupId}.json`;
            
            // Add to backup history
            const backupRecord = {
                id: backupId,
                type: 'full',
                timestamp: backupData.timestamp,
                created_by: currentUser.username,
                filename: filename,
                size: JSON.stringify(backupData).length,
                status: 'completed'
            };
            
            backupHistory.push(backupRecord);
            
            // Download backup file
            downloadBackupFile(backupData, filename);
            
            // Log backup creation
            logActivity('backup_created', {
                backup_id: backupId,
                backup_type: 'full',
                backup_size: backupRecord.size,
                filename: filename
            }, 'info');
            
            // Update display
            updateBackupHistoryDisplay();
            autoBackupSettings.lastBackup = backupData.timestamp;
            updateAutoBackupDisplay();
            
            alert(`Full system backup created successfully!\nBackup ID: ${backupId}\nFile: ${filename}`);
        }

        function createTransactionBackup() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                type: 'transactions',
                created_by: currentUser.username,
                data: {
                    transactionHistory: transactionHistory,
                    voidHistory: voidHistory,
                    shiftHistory: shiftHistory,
                    financialLedger: financialLedger
                }
            };
            
            const backupId = `TRANS_${Date.now()}`;
            const filename = `cafe_pos_transactions_backup_${new Date().toISOString().split('T')[0]}_${backupId}.json`;
            
            const backupRecord = {
                id: backupId,
                type: 'transactions',
                timestamp: backupData.timestamp,
                created_by: currentUser.username,
                filename: filename,
                size: JSON.stringify(backupData).length,
                status: 'completed'
            };
            
            backupHistory.push(backupRecord);
            downloadBackupFile(backupData, filename);
            
            logActivity('backup_created', {
                backup_id: backupId,
                backup_type: 'transactions',
                backup_size: backupRecord.size,
                filename: filename
            }, 'info');
            
            updateBackupHistoryDisplay();
            
            alert(`Transaction backup created successfully!\nBackup ID: ${backupId}\nFile: ${filename}`);
        }

        function createSettingsBackup() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                type: 'settings',
                created_by: currentUser.username,
                data: {
                    systemUsers: systemUsers,
                    systemSettings: systemSettings,
                    menuItems: menuItems,
                    categories: categories,
                    autoBackupSettings: autoBackupSettings
                }
            };
            
            const backupId = `SETTINGS_${Date.now()}`;
            const filename = `cafe_pos_settings_backup_${new Date().toISOString().split('T')[0]}_${backupId}.json`;
            
            const backupRecord = {
                id: backupId,
                type: 'settings',
                timestamp: backupData.timestamp,
                created_by: currentUser.username,
                filename: filename,
                size: JSON.stringify(backupData).length,
                status: 'completed'
            };
            
            backupHistory.push(backupRecord);
            downloadBackupFile(backupData, filename);
            
            logActivity('backup_created', {
                backup_id: backupId,
                backup_type: 'settings',
                backup_size: backupRecord.size,
                filename: filename
            }, 'info');
            
            updateBackupHistoryDisplay();
            
            alert(`Settings backup created successfully!\nBackup ID: ${backupId}\nFile: ${filename}`);
        }

        function downloadBackupFile(backupData, filename) {
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function restoreFromFile() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            const fileInput = document.getElementById('restoreFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a backup file to restore');
                return;
            }
            
            if (!file.name.includes('cafe_pos') || !file.name.endsWith('.json')) {
                alert('Invalid backup file. Please select a valid Cafe POS backup file.');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è WARNING: Restoring will overwrite ALL current data.\n\nThis action cannot be undone. Are you sure you want to continue?')) {
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validate backup file structure
                    if (!backupData.version || !backupData.data || !backupData.timestamp) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Create current system backup before restore
                    const preRestoreBackup = {
                        version: '1.0',
                        timestamp: new Date().toISOString(),
                        type: 'pre_restore',
                        created_by: currentUser.username,
                        data: {
                            systemUsers: systemUsers,
                            systemSettings: systemSettings,
                            menuItems: menuItems,
                            categories: categories,
                            transactionHistory: transactionHistory,
                            voidHistory: voidHistory,
                            shiftHistory: shiftHistory,
                            financialLedger: financialLedger,
                            activityLog: activityLog.slice(-500),
                            backupHistory: backupHistory,
                            autoBackupSettings: autoBackupSettings
                        }
                    };
                    
                    // Save pre-restore backup
                    const preRestoreFilename = `cafe_pos_pre_restore_backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                    downloadBackupFile(preRestoreBackup, preRestoreFilename);
                    
                    // Restore data based on backup type
                    if (backupData.type === 'full') {
                        restoreFullSystem(backupData.data);
                    } else if (backupData.type === 'transactions') {
                        restoreTransactionData(backupData.data);
                    } else if (backupData.type === 'settings') {
                        restoreSettingsData(backupData.data);
                    } else {
                        throw new Error('Unknown backup type: ' + backupData.type);
                    }
                    
                    // Log restore activity
                    logActivity('system_restored', {
                        backup_type: backupData.type,
                        backup_timestamp: backupData.timestamp,
                        backup_created_by: backupData.created_by,
                        restored_by: currentUser.username,
                        pre_restore_backup: preRestoreFilename
                    }, 'warning');
                    
                    alert(`System restored successfully from ${backupData.type} backup!\n\nBackup Date: ${new Date(backupData.timestamp).toLocaleString()}\nCreated By: ${backupData.created_by}\n\nPre-restore backup saved as: ${preRestoreFilename}\n\nThe system will now reload.`);
                    
                    // Reload the page to reflect changes
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Restore error:', error);
                    alert(`Failed to restore backup: ${error.message}\n\nPlease check that the file is a valid Cafe POS backup file.`);
                    
                    logActivity('restore_failed', {
                        filename: file.name,
                        error: error.message,
                        attempted_by: currentUser.username
                    }, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function restoreFullSystem(data) {
            // Restore all system data
            if (data.systemUsers) systemUsers = data.systemUsers;
            if (data.systemSettings) systemSettings = data.systemSettings;
            if (data.menuItems) menuItems = data.menuItems;
            if (data.categories) categories = data.categories;
            if (data.transactionHistory) transactionHistory = data.transactionHistory;
            if (data.voidHistory) voidHistory = data.voidHistory;
            if (data.shiftHistory) shiftHistory = data.shiftHistory;
            if (data.financialLedger) financialLedger = data.financialLedger;
            if (data.activityLog) activityLog = [...activityLog, ...data.activityLog];
            if (data.backupHistory) backupHistory = data.backupHistory;
            if (data.autoBackupSettings) autoBackupSettings = data.autoBackupSettings;
            
            // Update receipt counter based on restored transactions
            if (transactionHistory.length > 0) {
                const lastReceipt = Math.max(...transactionHistory.map(t => parseInt(t.receipt_number)));
                receiptCounter = lastReceipt + 1;
            }
        }

        function restoreTransactionData(data) {
            // Restore only transaction-related data
            if (data.transactionHistory) transactionHistory = data.transactionHistory;
            if (data.voidHistory) voidHistory = data.voidHistory;
            if (data.shiftHistory) shiftHistory = data.shiftHistory;
            if (data.financialLedger) financialLedger = data.financialLedger;
            
            // Update receipt counter
            if (transactionHistory.length > 0) {
                const lastReceipt = Math.max(...transactionHistory.map(t => parseInt(t.receipt_number)));
                receiptCounter = lastReceipt + 1;
            }
        }

        function restoreSettingsData(data) {
            // Restore settings and configuration data
            if (data.systemUsers) systemUsers = data.systemUsers;
            if (data.systemSettings) systemSettings = data.systemSettings;
            if (data.menuItems) menuItems = data.menuItems;
            if (data.categories) categories = data.categories;
            if (data.autoBackupSettings) autoBackupSettings = data.autoBackupSettings;
        }

        function updateBackupHistoryDisplay() {
            const container = document.getElementById('backupHistoryList');
            
            if (backupHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No backup history available</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            const sortedBackups = [...backupHistory].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            let historyHTML = '';
            sortedBackups.slice(0, 10).forEach(backup => { // Show last 10 backups
                const date = new Date(backup.timestamp);
                const timeAgo = getTimeAgo(date);
                const sizeKB = (backup.size / 1024).toFixed(1);
                
                const typeColors = {
                    'full': 'bg-green-100 text-green-800',
                    'transactions': 'bg-blue-100 text-blue-800',
                    'settings': 'bg-purple-100 text-purple-800',
                    'pre_restore': 'bg-orange-100 text-orange-800'
                };
                
                const typeIcons = {
                    'full': 'üì¶',
                    'transactions': 'üßæ',
                    'settings': '‚öôÔ∏è',
                    'pre_restore': 'üîÑ'
                };
                
                historyHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-lg">${typeIcons[backup.type] || 'üìÑ'}</span>
                                <span class="font-medium text-gray-800">${backup.id}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${typeColors[backup.type] || 'bg-gray-100 text-gray-800'}">${backup.type}</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                ${date.toLocaleDateString()} ${date.toLocaleTimeString()} ‚Ä¢ ${timeAgo}
                            </div>
                            <div class="text-xs text-gray-500">
                                Created by: ${backup.created_by} ‚Ä¢ Size: ${sizeKB} KB
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-500 mb-1">${backup.status}</div>
                            <button onclick="downloadBackupById('${backup.id}')" class="text-blue-600 hover:text-blue-800 text-sm touch-btn" title="Download backup">
                                üì• Download
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = historyHTML;
        }

        function updateAutoBackupSettings() {
            const frequency = document.getElementById('autoBackupFrequency').value;
            const type = document.getElementById('autoBackupType').value;
            const retention = parseInt(document.getElementById('autoBackupRetention').value);
            
            autoBackupSettings.frequency = frequency;
            autoBackupSettings.type = type;
            autoBackupSettings.retention = retention;
            
            // Calculate next backup time
            if (frequency !== 'disabled') {
                const now = new Date();
                let nextBackup = new Date(now);
                
                switch (frequency) {
                    case 'daily':
                        nextBackup.setDate(now.getDate() + 1);
                        nextBackup.setHours(2, 0, 0, 0); // 2 AM
                        break;
                    case 'weekly':
                        nextBackup.setDate(now.getDate() + (7 - now.getDay())); // Next Sunday
                        nextBackup.setHours(2, 0, 0, 0);
                        break;
                    case 'monthly':
                        nextBackup.setMonth(now.getMonth() + 1, 1); // First day of next month
                        nextBackup.setHours(2, 0, 0, 0);
                        break;
                }
                
                autoBackupSettings.nextBackup = nextBackup.toISOString();
            } else {
                autoBackupSettings.nextBackup = null;
            }
            
            updateAutoBackupDisplay();
            
            // Log settings change
            logActivity('auto_backup_settings_changed', {
                frequency: frequency,
                type: type,
                retention: retention,
                next_backup: autoBackupSettings.nextBackup
            }, 'info');
            
            alert('Auto backup settings updated successfully!');
        }

        function updateAutoBackupDisplay() {
            const nextBackupElement = document.getElementById('nextAutoBackup');
            
            if (autoBackupSettings.nextBackup) {
                const nextDate = new Date(autoBackupSettings.nextBackup);
                nextBackupElement.textContent = nextDate.toLocaleString();
                nextBackupElement.className = 'text-sm text-blue-600';
            } else {
                nextBackupElement.textContent = 'Not scheduled';
                nextBackupElement.className = 'text-sm text-gray-500';
            }
            
            // Update form values
            document.getElementById('autoBackupFrequency').value = autoBackupSettings.frequency;
            document.getElementById('autoBackupType').value = autoBackupSettings.type;
            document.getElementById('autoBackupRetention').value = autoBackupSettings.retention;
        }

        function triggerManualAutoBackup() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            if (autoBackupSettings.frequency === 'disabled') {
                alert('Auto backup is disabled. Please enable it first or use manual backup options.');
                return;
            }
            
            // Trigger backup based on configured type
            switch (autoBackupSettings.type) {
                case 'full':
                    createFullBackup();
                    break;
                case 'transactions':
                    createTransactionBackup();
                    break;
                case 'settings':
                    createSettingsBackup();
                    break;
                default:
                    createFullBackup();
            }
            
            // Update last backup time
            autoBackupSettings.lastBackup = new Date().toISOString();
            updateAutoBackupDisplay();
        }

        function downloadBackupById(backupId) {
            const backup = backupHistory.find(b => b.id === backupId);
            if (!backup) {
                alert('Backup not found');
                return;
            }
            
            alert('Backup download feature would be available in a real implementation.\n\nIn this demo, backups are automatically downloaded when created.');
        }

        // Placeholder functions for features not fully implemented in mobile version
        function showAddCategory() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            alert('Add category feature available in desktop version');
        }

        function showAddItem() {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            alert('Add item feature available in desktop version');
        }

        function deleteMenuItem(itemId) {
            if (!hasPermission('admin')) {
                alert('Access denied. Admin privileges required.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }
            
            const itemIndex = menuItems.findIndex(item => item.id === itemId);
            if (itemIndex !== -1) {
                menuItems.splice(itemIndex, 1);
                displayMenuItems(menuItems);
                alert('Menu item deleted successfully!');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98533cb5d17bdd4a',t:'MTc1ODg5NDY5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
